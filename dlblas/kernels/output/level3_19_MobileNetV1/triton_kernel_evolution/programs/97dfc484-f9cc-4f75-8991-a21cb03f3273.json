{"id": "97dfc484-f9cc-4f75-8991-a21cb03f3273", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef fused_conv_bn_relu(\n    x_ptr, weight_ptr, bias_ptr, gamma_ptr, beta_ptr, \n    mean_ptr, var_ptr, output_ptr,\n    stride: tl.constexpr, groups: tl.constexpr,\n    H: tl.constexpr, W: tl.constexpr, eps: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    offsets = pid * BLOCK_SIZE + tl.arange(0, BLOCK_SIZE)\n    mask = offsets < H * W\n    \n    # Load inputs\n    x = tl.load(x_ptr + offsets, mask=mask, other=0)\n    weight = tl.load(weight_ptr + offsets, mask=mask, other=0)\n    bias = tl.load(bias_ptr + offsets, mask=mask, other=0)\n    gamma = tl.load(gamma_ptr + offsets, mask=mask, other=0)\n    beta = tl.load(beta_ptr + offsets, mask=mask, other=0)\n    mean = tl.load(mean_ptr + offsets, mask=mask, other=0)\n    var = tl.load(var_ptr + offsets, mask=mask, other=0)\n    \n    # Fused convolution-batchnorm-relu\n    conv_out = x * weight + bias\n    bn_out = gamma * (conv_out - mean) / tl.sqrt(var + eps) + beta\n    relu_out = tl.maximum(bn_out, 0)\n    \n    tl.store(output_ptr + offsets, relu_out, mask=mask)\n\nclass DepthwiseConv2d(nn.Module):\n    def __init__(self, inp, oup, stride):\n        super().__init__()\n        self.conv = nn.Conv2d(inp, inp, 3, stride, 1, groups=inp, bias=False)\n        self.bn = nn.BatchNorm2d(inp)\n        self.relu = nn.ReLU(inplace=True)\n        self.pointwise = nn.Conv2d(inp, oup, 1, 1, 0, bias=False)\n        self.bn2 = nn.BatchNorm2d(oup)\n        self.relu2 = nn.ReLU(inplace=True)\n        \n    def forward(self, x):\n        # Depthwise convolution fused with Triton\n        N, C, H, W = x.shape\n        weight = self.conv.weight\n        bias = torch.zeros_like(self.bn.bias)  # Conv has no bias\n        \n        # Prepare inputs for Triton kernel\n        x_flat = x.view(N, C, -1)\n        out = torch.empty_like(x_flat)\n        grid = lambda _: (C,)\n        \n        fused_conv_bn_relu[grid](\n            x_flat, weight.view(C, -1), bias, \n            self.bn.weight, self.bn.bias,\n            self.bn.running_mean, self.bn.running_var,\n            out, self.conv.stride[0], self.conv.groups,\n            H, W, self.bn.eps, BLOCK_SIZE=H*W\n        )\n        \n        x = out.view(N, C, H, W)\n        x = self.pointwise(x)\n        x = self.bn2(x)\n        x = self.relu2(x)\n        return x\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_classes=1000, input_channels=3, alpha=1.0):\n        super(ModelNew, self).__init__()\n        \n        def conv_bn(inp, oup, stride):\n            return nn.Sequential(\n                nn.Conv2d(inp, oup, 3, stride, 1, bias=False),\n                nn.BatchNorm2d(oup),\n                nn.ReLU(inplace=True)\n            )\n        \n        self.model = nn.Sequential(\n            conv_bn(input_channels, int(32 * alpha), 2),\n            DepthwiseConv2d(int(32 * alpha), int(64 * alpha), 1),\n            DepthwiseConv2d(int(64 * alpha), int(128 * alpha), 2),\n            DepthwiseConv2d(int(128 * alpha), int(128 * alpha), 1),\n            DepthwiseConv2d(int(128 * alpha), int(256 * alpha), 2),\n            DepthwiseConv2d(int(256 * alpha), int(256 * alpha), 1),\n            DepthwiseConv2d(int(256 * alpha), int(512 * alpha), 2),\n            DepthwiseConv2d(int(512 * alpha), int(512 * alpha), 1),\n            DepthwiseConv2d(int(512 * alpha), int(512 * alpha), 1),\n            DepthwiseConv2d(int(512 * alpha), int(512 * alpha), 1),\n            DepthwiseConv2d(int(512 * alpha), int(512 * alpha), 1),\n            DepthwiseConv2d(int(512 * alpha), int(512 * alpha), 1),\n            DepthwiseConv2d(int(512 * alpha), int(1024 * alpha), 2),\n            DepthwiseConv2d(int(1024 * alpha), int(1024 * alpha), 1),\n            nn.AvgPool2d(7),\n        )\n        self.fc = nn.Linear(int(1024 * alpha), num_classes)\n    \n    def forward(self, x):\n        x = self.model(x)\n        x = x.view(x.size(0), -1)\n        x = self.fc(x)\n        return x\n\n# Test code\nbatch_size = 10\ninput_channels = 3\nheight = 224\nwidth = 224\nnum_classes = 1000\nalpha = 1.0\n\ndef get_inputs():\n    return [torch.randn(batch_size, input_channels, height, width)]\n\ndef get_init_inputs():\n    return [num_classes, input_channels, alpha]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "a52f9c18-acc3-45b2-a401-884496313d50", "generation": 1, "timestamp": 1754584182.0506315, "iteration_found": 3, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_19_MobileNetV1", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:1", "runtime_error": "Traceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1654, in arange\n    return _semantic.arange(start, end)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 583, in arange\n    raise ValueError(\"arange's range must be a power of 2\")\nValueError: arange's range must be a power of 2\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpiwxy4o0_.py\", line 102, in forward\n    x = self.model(x)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/container.py\", line 244, in forward\n    input = module(input)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpiwxy4o0_.py\", line 57, in forward\n    fused_conv_bn_relu[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 9:33:\ndef fused_conv_bn_relu(\n    x_ptr, weight_ptr, bias_ptr, gamma_ptr, beta_ptr, \n    mean_ptr, var_ptr, output_ptr,\n    stride: tl.constexpr, groups: tl.constexpr,\n    H: tl.constexpr, W: tl.constexpr, eps: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    offsets = pid * BLOCK_SIZE + tl.arange(0, BLOCK_SIZE)\n                                 ^\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1654, in arange\n    return _semantic.arange(start, end)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 583, in arange\n    raise ValueError(\"arange's range must be a power of 2\")\nValueError: arange's range must be a power of 2\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 1.36, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 1.63, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "correctness_trials": "(5 / 5)", "reference_timing_ms": 1.36, "speed_up": 0.834, "custom_timing": 1.63}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}