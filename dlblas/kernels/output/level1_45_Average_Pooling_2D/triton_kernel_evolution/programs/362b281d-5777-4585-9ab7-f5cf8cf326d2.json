{"id": "362b281d-5777-4585-9ab7-f5cf8cf326d2", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _avg_pool2d_kernel(\n    x_ptr,\n    output_ptr,\n    batch_size,\n    channels,\n    height,\n    width,\n    out_h,\n    out_w,\n    stride,\n    padding,\n    kernel_size: tl.constexpr,\n    total_output_elements: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    idx = tl.arange(0, BLOCK_SIZE)\n    output_index = pid * BLOCK_SIZE + idx\n    mask = output_index < total_output_elements\n    \n    # Compute output tensor strides\n    S = channels * out_h * out_w\n    C_stride = out_h * out_w\n    H_stride = out_w\n    \n    # Unravel output indices\n    batch_i = tl.where(mask, output_index // S, 0)\n    channel_i = tl.where(mask, (output_index % S) // C_stride, 0)\n    pos_2d = tl.where(mask, output_index % C_stride, 0)\n    out_h_i = tl.where(mask, pos_2d // H_stride, 0)\n    out_w_i = tl.where(mask, pos_2d % H_stride, 0)\n    \n    # Compute input window\n    h_start = out_h_i * stride - padding\n    w_start = out_w_i * stride - padding\n    \n    # Input tensor strides\n    x_batch_stride = channels * height * width\n    x_channel_stride = height * width\n    x_base = x_ptr + batch_i * x_batch_stride + channel_i * x_channel_stride\n    \n    total = tl.zeros((BLOCK_SIZE,), dtype=tl.float32)\n    area = kernel_size * kernel_size\n    \n    # Optimized for 3x3 kernel\n    for kh in range(0, kernel_size):\n        for kw in range(0, kernel_size):\n            h = h_start + kh\n            w = w_start + kw\n            within_bounds = (h >= 0) & (h < height) & (w >= 0) & (w < width)\n            offset = h * width + w\n            value = tl.load(x_base + offset, mask=mask & within_bounds, other=0.0)\n            total += value\n\n    # Store averaged results\n    output_val = total / area\n    output_offset = batch_i * S + channel_i * C_stride + out_h_i * out_w + out_w_i\n    tl.store(output_ptr + output_offset, output_val, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, kernel_size: int, stride: int = None, padding: int = 0):\n        super(ModelNew, self).__init__()\n        if stride is None:\n            stride = kernel_size\n        self.kernel_size = kernel_size\n        self.stride = stride\n        self.padding = padding\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        batch_size, channels, height, width = x.shape\n        out_h = (height + 2*self.padding - self.kernel_size) // self.stride + 1\n        out_w = (width + 2*self.padding - self.kernel_size) // self.stride + 1\n        total_output_elements = batch_size * channels * out_h * out_w\n        \n        output = torch.empty((batch_size, channels, out_h, out_w), \n                             device=x.device, dtype=x.dtype)\n        \n        if total_output_elements == 0:\n            return output\n            \n        BLOCK_SIZE = 128\n        grid = (triton.cdiv(total_output_elements, BLOCK_SIZE),)\n        \n        _avg_pool2d_kernel[grid](\n            x, output,\n            batch_size, channels, height, width,\n            out_h, out_w,\n            self.stride, self.padding, self.kernel_size,\n            total_output_elements,\n            BLOCK_SIZE=BLOCK_SIZE,\n        )\n        return output\n\nbatch_size = 16\nchannels = 64\nheight = 256\nwidth = 256\nkernel_size = 3\n\ndef get_inputs():\n    x = torch.randn(batch_size, channels, height, width)\n    return [x]\n\ndef get_init_inputs():\n    return [kernel_size]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "2c4f8eca-5210-42f1-a766-9e43b05f19b5", "generation": 1, "timestamp": 1754642641.6054163, "iteration_found": 3, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.148, "runtime_ms": 0.135, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:6", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.02, "speed_up": 0.148, "custom_timing": 0.135}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.134, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.02, "speed_up": 0.149, "custom_timing": 0.134}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}