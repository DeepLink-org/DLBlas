{"id": "a38f33ae-0dfe-4faf-874f-4e0e119b6af2", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _avg_pool2d_kernel(\n    x_ptr,\n    output_ptr,\n    batch_size,\n    channels,\n    height,\n    width,\n    out_height,\n    out_width,\n    stride,\n    padding,\n    kernel_size: tl.constexpr,\n    total_output_elements: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    idx = tl.arange(0, BLOCK_SIZE)\n    output_index = pid * BLOCK_SIZE + idx\n    mask = output_index < total_output_elements\n    \n    # Unravel output indices to (b, c, oh, ow)\n    S = channels * out_height * out_width\n    C_stride = out_height * out_width\n    H_stride = out_width\n    \n    batch_i = tl.where(mask, output_index // S, 0)\n    channel_i = tl.where(mask, (output_index % S) // C_stride, 0)\n    pos_2d = tl.where(mask, output_index % C_stride, 0)\n    oh = tl.where(mask, pos_2d // H_stride, 0)\n    ow = tl.where(mask, pos_2d % H_stride, 0)\n    \n    # Compute input window start positions\n    h_start = oh * stride - padding\n    w_start = ow * stride - padding\n    \n    # Precompute base pointer offsets\n    x_batch_stride = channels * height * width\n    x_channel_stride = height * width\n    base_ptr = x_ptr + batch_i * x_batch_stride + channel_i * x_channel_stride\n    \n    total = tl.zeros((BLOCK_SIZE,), dtype=tl.float32)\n    count = tl.zeros((BLOCK_SIZE,), dtype=tl.float32)\n\n    # Process kernel window\n    for kh in range(0, kernel_size):\n        for kw in range(0, kernel_size):\n            h = h_start + kh\n            w = w_start + kw\n            \n            # Check boundaries and create mask\n            within_bounds = (h >= 0) & (h < height) & (w >= 0) & (w < width)\n            full_mask = mask & within_bounds\n            \n            # Compute offset and load values\n            offset = h * width + w\n            value = tl.load(base_ptr + offset, mask=full_mask, other=0.0)\n            total += value\n            count += tl.where(full_mask, 1.0, 0.0)\n\n    # Compute average and store results\n    avg = tl.where(count > 0, total / count, 0.0)\n    tl.store(output_ptr + output_index, avg, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, kernel_size: int, stride: int = None, padding: int = 0):\n        super(ModelNew, self).__init__()\n        if stride is None:\n            stride = kernel_size\n        self.kernel_size = kernel_size\n        self.stride = stride\n        self.padding = padding\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        x = x.contiguous()\n        batch_size, channels, height, width = x.shape\n        out_height = (height + 2*self.padding - self.kernel_size) // self.stride + 1\n        out_width = (width + 2*self.padding - self.kernel_size) // self.stride + 1\n        total_output_elements = batch_size * channels * out_height * out_width\n        \n        output = torch.empty((batch_size, channels, out_height, out_width), \n                             device=x.device, dtype=x.dtype)\n        \n        if total_output_elements == 0:\n            return output\n            \n        BLOCK_SIZE = 128\n        grid = (triton.cdiv(total_output_elements, BLOCK_SIZE),)\n        \n        _avg_pool2d_kernel[grid](\n            x, output,\n            batch_size, channels, height, width,\n            out_height, out_width,\n            self.stride, self.padding, self.kernel_size,\n            total_output_elements,\n            BLOCK_SIZE=BLOCK_SIZE,\n        )\n        return output\n\nbatch_size = 16\nchannels = 64\nheight = 256\nwidth = 256\nkernel_size = 3\n\ndef get_inputs():\n    x = torch.randn(batch_size, channels, height, width)\n    return [x]\n\ndef get_init_inputs():\n    return [kernel_size]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "7bf650cf-86e5-480e-8311-b7c4f09d5067", "generation": 3, "timestamp": 1754645971.6320062, "iteration_found": 22, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.147, "runtime_ms": 0.136, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:4", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.02, "speed_up": 0.147, "custom_timing": 0.136}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": false, "correctness": false, "score": -100.0, "stage": "no_valid_triton_code", "feedback": "You need to generate real and valid triton code for the core function. The key word 'import triton' is not found."}, "island": 2}, "artifacts_json": null, "artifact_dir": null}