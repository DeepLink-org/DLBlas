{"id": "1a69e5f3-1f32-4bf1-b291-f30d58354b47", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef depthwise_conv_kernel(\n    input_ptr, weight_ptr, output_ptr,\n    input_batch, input_channels, input_height, input_width,\n    stride, padding,\n    output_batch, output_channels, output_height, output_width,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    pid_b = pid // (output_channels * output_height * output_width // BLOCK_SIZE)\n    pid_c = (pid % (output_channels * output_height * output_width // BLOCK_SIZE)) // (output_height * output_width // BLOCK_SIZE)\n    pid_hw = pid % (output_height * output_width // BLOCK_SIZE)\n    \n    # Vectorized loads/stores\n    for idx in range(BLOCK_SIZE):\n        hw_idx = pid_hw * BLOCK_SIZE + idx\n        h_out = hw_idx // output_width\n        w_out = hw_idx % output_width\n        \n        acc = 0.0\n        for kh in range(3):\n            for kw in range(3):\n                h_in = h_out * stride - padding + kh\n                w_in = w_out * stride - padding + kw\n                if h_in >= 0 and h_in < input_height and w_in >=0 and w_in < input_width:\n                    input_offset = pid_b * input_channels * input_height * input_width + \\\n                                  pid_c * input_height * input_width + \\\n                                  h_in * input_width + w_in\n                    weight_offset = pid_c * 9 + kh * 3 + kw\n                    acc += tl.load(input_ptr + input_offset) * tl.load(weight_ptr + weight_offset)\n        \n        output_offset = pid_b * output_channels * output_height * output_width + \\\n                        pid_c * output_height * output_width + \\\n                        h_out * output_width + w_out\n        tl.store(output_ptr + output_offset, acc)\n\nclass TritonDepthwiseConv2d(nn.Module):\n    def __init__(self, in_channels, kernel_size, stride, padding, bias=False):\n        super().__init__()\n        self.in_channels = in_channels\n        self.stride = stride\n        self.padding = padding\n        self.weight = nn.Parameter(torch.empty(in_channels, 1, kernel_size, kernel_size))\n        if bias:\n            self.bias = nn.Parameter(torch.empty(in_channels))\n        else:\n            self.bias = None\n        nn.init.kaiming_uniform_(self.weight, a=math.sqrt(5))\n        if self.bias is not None:\n            fan_in, _ = nn.init._calculate_fan_in_and_fan_out(self.weight)\n            bound = 1 / math.sqrt(fan_in)\n            nn.init.uniform_(self.bias, -bound, bound)\n            \n    def forward(self, x):\n        batch, in_channels, H, W = x.shape\n        H_out = (H + 2 * self.padding - 3) // self.stride + 1\n        W_out = (W + 2 * self.padding - 3) // self.stride + 1\n        output = torch.empty(batch, in_channels, H_out, W_out, device=x.device, dtype=x.dtype)\n        \n        grid = (batch * in_channels * (H_out * W_out) // 256,)\n        depthwise_conv_kernel[grid](\n            x, self.weight, output,\n            batch, in_channels, H, W,\n            self.stride, self.padding,\n            batch, in_channels, H_out, W_out,\n            BLOCK_SIZE=256\n        )\n        if self.bias is not None:\n            output += self.bias.view(1, -1, 1, 1)\n        return output\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_classes=1000):\n        super(ModelNew, self).__init__()\n        self.conv1 = nn.Conv2d(3, 32, kernel_size=3, stride=2, padding=1, bias=False)\n        self.bn1 = nn.BatchNorm2d(32)\n        self.mbconv1 = self._make_mbconv_block(32, 16, 1, 1)\n        self.mbconv2 = self._make_mbconv_block(16, 24, 2, 6)\n        self.mbconv3 = self._make_mbconv_block(24, 40, 2, 6)\n        self.mbconv4 = self._make_mbconv_block(40, 80, 2, 6)\n        self.mbconv5 = self._make_mbconv_block(80, 112, 1, 6)\n        self.mbconv6 = self._make_mbconv_block(112, 192, 2, 6)\n        self.mbconv7 = self._make_mbconv_block(192, 320, 1, 6)\n        self.conv2 = nn.Conv2d(320, 1280, kernel_size=1, stride=1, padding=0, bias=False)\n        self.bn2 = nn.BatchNorm2d(1280)\n        self.fc = nn.Linear(1280, num_classes)\n    \n    def _make_mbconv_block(self, in_channels, out_channels, stride, expand_ratio):\n        hidden_dim = round(in_channels * expand_ratio)\n        return nn.Sequential(\n            nn.Conv2d(in_channels, hidden_dim, 1, 1, 0, bias=False),\n            nn.BatchNorm2d(hidden_dim),\n            nn.ReLU6(inplace=True),\n            TritonDepthwiseConv2d(hidden_dim, 3, stride, 1),\n            nn.BatchNorm2d(hidden_dim),\n            nn.ReLU6(inplace=True),\n            nn.Conv2d(hidden_dim, out_channels, 1, 1, 0, bias=False),\n            nn.BatchNorm2d(out_channels),\n        )\n    \n    def forward(self, x):\n        x = F.relu(self.bn1(self.conv1(x)))\n        x = self.mbconv1(x)\n        x = self.mbconv2(x)\n        x = self.mbconv3(x)\n        x = self.mbconv4(x)\n        x = self.mbconv5(x)\n        x = self.mbconv6(x)\n        x = self.mbconv7(x)\n        x = F.relu(self.bn2(self.conv2(x)))\n        x = F.adaptive_avg_pool2d(x, (1, 1))\n        x = torch.flatten(x, 1)\n        x = self.fc(x)\n        return x\n\nbatch_size = 10\ninput_shape = (3, 240, 240)\nnum_classes = 1000\n\ndef get_inputs():\n    return [torch.randn(batch_size, *input_shape)]\n\ndef get_init_inputs():\n    return [num_classes]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "8e5a66de-92ef-495b-a86a-e0b877cc446c", "generation": 1, "timestamp": 1754587438.5601768, "iteration_found": 2, "metrics": {"compiled": false, "correctness": false, "score": 1, "stage": "compile_error", "compile_log": "name 'math' is not defined\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/evaluator.py\", line 173, in _verification_worker\n    result: KernelExecResult = eval_kernel_against_ref(\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 484, in eval_kernel_against_ref\n    custom_model = ModelNew(*init_args, **init_kwargs)\n  File \"/tmp/tmpm3fklqn6.py\", line 84, in __init__\n    self.mbconv1 = self._make_mbconv_block(32, 16, 1, 1)\n  File \"/tmp/tmpm3fklqn6.py\", line 101, in _make_mbconv_block\n    TritonDepthwiseConv2d(hidden_dim, 3, stride, 1),\n  File \"/tmp/tmpm3fklqn6.py\", line 55, in __init__\n    nn.init.kaiming_uniform_(self.weight, a=math.sqrt(5))\nNameError: name 'math' is not defined\n", "exec_log": "[Child] \u7ed1\u5b9a GPU 4, torch sees 1 device(s)\n\n[Exception]\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/code_executor.py\", line 71, in _exec_worker\n    exec(textwrap.dedent(code_src), mod.__dict__)\n  File \"<string>\", line 9, in <module>\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 844, in jit\n    return decorator(fn)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 832, in decorator\n    return JITFunction(\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 635, in __init__\n    self.starting_line_number = inspect.getsourcelines(fn)[1]\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/inspect.py\", line 1121, in getsourcelines\n    lines, lnum = findsource(object)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/inspect.py\", line 958, in findsource\n    raise OSError('could not get source code')\nOSError: could not get source code\n", "exit_code": "1"}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 1.67, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "correctness_trials": "(5 / 5)", "reference_timing_ms": 1.5, "speed_up": 0.898, "custom_timing": 1.67}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}