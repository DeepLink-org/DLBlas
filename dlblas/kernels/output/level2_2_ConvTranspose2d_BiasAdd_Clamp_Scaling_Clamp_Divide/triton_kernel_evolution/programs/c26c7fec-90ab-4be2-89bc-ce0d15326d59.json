{"id": "c26c7fec-90ab-4be2-89bc-ce0d15326d59", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _elementwise_kernel(\n    x_ptr,\n    bias_ptr,\n    output_ptr,\n    scaling_factor,\n    h, w, c, n,\n    stride_xn, stride_xc, stride_xh, stride_xw,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    num_pids = tl.num_programs(0)\n    elements_per_program = (h * w + BLOCK_SIZE - 1) // BLOCK_SIZE\n    batch_id = pid // (c * elements_per_program)\n    channel_id = (pid % (c * elements_per_program)) // elements_per_program\n    block_id = pid % elements_per_program\n    \n    # Calculate spatial offsets\n    spatial_start = block_id * BLOCK_SIZE\n    spatial_offsets = spatial_start + tl.arange(0, BLOCK_SIZE)\n    spatial_mask = spatial_offsets < (h * w)\n    \n    # Calculate full tensor indices\n    batch_offset = batch_id * stride_xn\n    channel_offset = channel_id * stride_xc\n    spatial_indices = spatial_offsets // w, spatial_offsets % w\n    h_offsets, w_offsets = spatial_indices\n    \n    # Compute memory locations\n    x_ptrs = (\n        x_ptr + \n        batch_offset + \n        channel_offset + \n        h_offsets * stride_xh + \n        w_offsets * stride_xw\n    )\n    \n    # Load data with mask\n    x_vals = tl.load(x_ptrs, mask=spatial_mask, other=0.0)\n    bias_val = tl.load(bias_ptr + channel_id)\n    \n    # Fused operations\n    y = x_vals + bias_val\n    y = tl.minimum(tl.maximum(y, 0.0), 1.0)\n    y = y * scaling_factor\n    y = tl.minimum(tl.maximum(y, 0.0), 1.0)\n    y = y / scaling_factor\n    \n    # Store results\n    tl.store(x_ptrs, y, mask=spatial_mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size, stride, padding, output_padding, bias_shape, scaling_factor):\n        super(ModelNew, self).__init__()\n        self.conv_transpose = nn.ConvTranspose2d(in_channels, out_channels, kernel_size, stride=stride, padding=padding, output_padding=output_padding)\n        self.bias = nn.Parameter(torch.randn(bias_shape))\n        self.scaling_factor = scaling_factor\n\n    def forward(self, x):\n        x = self.conv_transpose(x)\n        n, c, h, w = x.shape\n        bias_flat = self.bias.view(-1)\n        \n        # Calculate strides\n        stride_xn = x.stride(0)\n        stride_xc = x.stride(1)\n        stride_xh = x.stride(2)\n        stride_xw = x.stride(3)\n        \n        # Configure kernel launch\n        elements_per_row = h * w\n        BLOCK_SIZE = 1024\n        grid = (n * c * ((elements_per_row + BLOCK_SIZE - 1) // BLOCK_SIZE),)\n        \n        # Launch kernel\n        _elementwise_kernel[grid](\n            x, \n            bias_flat, \n            x,  # in-place operation\n            self.scaling_factor,\n            h, w, c, n,\n            stride_xn, stride_xc, stride_xh, stride_xw,\n            BLOCK_SIZE=BLOCK_SIZE\n        )\n        return x\n\nbatch_size = 128\nin_channels = 3\nout_channels = 16\nheight, width = 32, 32\nkernel_size = 3\nstride = 2\npadding = 1\noutput_padding = 1\nbias_shape = (out_channels, 1, 1)\nscaling_factor = 2.0\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_channels, height, width)]\n\ndef get_init_inputs():\n    return [in_channels, out_channels, kernel_size, stride, padding, output_padding, bias_shape, scaling_factor]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "5eae8abc-aef9-47e9-a059-9be12dd24bc1", "generation": 1, "timestamp": 1754566294.9420843, "iteration_found": 3, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.607, "runtime_ms": 0.173, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.105, "speed_up": 0.607, "custom_timing": 0.173}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.282, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:0", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.105, "speed_up": 0.372, "custom_timing": 0.282}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}