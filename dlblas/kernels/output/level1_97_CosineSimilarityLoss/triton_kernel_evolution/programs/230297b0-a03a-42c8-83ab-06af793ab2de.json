{"id": "230297b0-a03a-42c8-83ab-06af793ab2de", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.autotune(\n    configs=[\n        triton.Config({'BLOCK_SIZE': 256}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 512}, num_warps=8),\n        triton.Config({'BLOCK_SIZE': 1024}, num_warps=16),\n    ],\n    key=['n_cols'],\n)\n@triton.jit\ndef _cosine_similarity_loss_rowwise(\n    pred_ptr, targ_ptr, output_ptr,\n    n_cols, \n    stride_pred, stride_targ,\n    BLOCK_SIZE: tl.constexpr,\n    eps: tl.constexpr\n):\n    pid = tl.program_id(0)\n    dot = 0.0\n    norm_p_sq = 0.0\n    norm_t_sq = 0.0\n\n    for off in range(0, n_cols, BLOCK_SIZE):\n        col_offsets = off + tl.arange(0, BLOCK_SIZE)\n        mask = col_offsets < n_cols\n\n        p_ptr = pred_ptr + pid * stride_pred + col_offsets\n        t_ptr = targ_ptr + pid * stride_targ + col_offsets\n\n        p_chunk = tl.load(p_ptr, mask=mask, other=0.0)\n        t_chunk = tl.load(t_ptr, mask=mask, other=0.0)\n\n        dot += tl.sum(p_chunk * t_chunk)\n        norm_p_sq += tl.sum(p_chunk * p_chunk)\n        norm_t_sq += tl.sum(t_chunk * t_chunk)\n\n    norm_p = tl.sqrt(norm_p_sq + eps)\n    norm_t = tl.sqrt(norm_t_sq + eps)\n    denom = tl.maximum(norm_p * norm_t, eps)\n    cos_sim = dot / denom\n    loss_i = 1.0 - cos_sim\n    tl.store(output_ptr + pid, loss_i)\n\nclass ModelNew(nn.Module):\n    def __init__(self):\n        super(ModelNew, self).__init__()\n    \n    def forward(self, predictions, targets):\n        batch_size, n_cols = predictions.shape\n        loss_per_row = torch.empty(batch_size, device=predictions.device, dtype=predictions.dtype)\n        \n        grid = (batch_size,)\n        _cosine_similarity_loss_rowwise[grid](\n            predictions, targets, loss_per_row,\n            n_cols, \n            predictions.stride(0), targets.stride(0),\n            BLOCK_SIZE=triton.next_power_of_2(n_cols),\n            eps=1e-8\n        )\n        \n        return torch.mean(loss_per_row)\n\nbatch_size = 128\ninput_shape = (4096, )\ndim = 1\n\ndef get_inputs():\n    return [torch.randn(batch_size, *input_shape), torch.randn(batch_size, *input_shape)]\n\ndef get_init_inputs():\n    return []\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "015ee8d7-0b28-423a-af57-f624e3812359", "generation": 1, "timestamp": 1754989606.875783, "iteration_found": 3, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level1_97_CosineSimilarityLoss", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:6", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpsnvxi2vp.py\", line 59, in forward\n    _cosine_similarity_loss_rowwise[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 239, in run\n    benchmark()\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 228, in benchmark\n    timings = {config: self._bench(*args, config=config, **kwargs) for config in pruned_configs}\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 228, in <dictcomp>\n    timings = {config: self._bench(*args, config=config, **kwargs) for config in pruned_configs}\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 135, in _bench\n    raise ValueError(f\"Conflicting meta-parameters: {', '.join(conflicts)}.\"\nValueError: Conflicting meta-parameters: BLOCK_SIZE. Make sure that you don't re-define auto-tuned symbols.\n", "runtime_error_name": "builtins.ValueError", "reference_timing_ms": 0.082, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.08, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.082, "speed_up": 1.025, "custom_timing": 0.08}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}