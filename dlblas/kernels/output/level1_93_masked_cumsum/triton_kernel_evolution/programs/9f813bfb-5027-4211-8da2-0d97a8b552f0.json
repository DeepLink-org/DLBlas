{"id": "9f813bfb-5027-4211-8da2-0d97a8b552f0", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef add_combine(a, b):\n    return a + b\n\n@triton.jit\ndef _masked_cumsum_kernel(\n    output_ptr,\n    x_ptr,\n    mask_ptr,\n    n_cols,\n    stride,\n    BLOCK_SIZE: tl.constexpr\n):\n    row_idx = tl.program_id(0)\n    start = row_idx * stride\n    offsets = start + tl.arange(0, BLOCK_SIZE)\n    mask_boundary = tl.arange(0, BLOCK_SIZE) < n_cols\n    x = tl.load(x_ptr + offsets, mask=mask_boundary, other=0.0)\n    m = tl.load(mask_ptr + offsets, mask=mask_boundary, other=False).to(tl.float32)\n    vals = x * m\n    cumsum = tl.associative_scan(vals, 0, add_combine)\n    tl.store(output_ptr + offsets, cumsum, mask=mask_boundary)\n\nclass ModelNew(nn.Module):\n    def __init__(self, dim):\n        super(ModelNew, self).__init__()\n        self.dim = dim\n\n    def forward(self, x, mask):\n        original_shape = x.shape\n        dim = self.dim if self.dim >= 0 else self.dim + x.dim()\n        \n        n_rows = 1\n        for i, s in enumerate(original_shape):\n            if i != dim:\n                n_rows *= s\n        n_cols = original_shape[dim]\n        \n        if n_cols == 0:\n            return torch.zeros_like(x)\n        \n        BLOCK_SIZE = triton.next_power_of_2(n_cols)\n        x_flat = x.moveaxis(dim, -1).contiguous().view(n_rows, n_cols)\n        mask_flat = mask.moveaxis(dim, -1).contiguous().view(n_rows, n_cols)\n        \n        x_flat_padded = torch.zeros((n_rows, BLOCK_SIZE), device=x.device, dtype=x.dtype)\n        mask_flat_padded = torch.zeros((n_rows, BLOCK_SIZE), device=mask.device, dtype=torch.bool)\n        x_flat_padded[:, :n_cols] = x_flat\n        mask_flat_padded[:, :n_cols] = mask_flat\n        \n        output_flat_padded = torch.empty((n_rows, BLOCK_SIZE), device=x.device, dtype=x.dtype)\n        \n        grid = (n_rows,)\n        _masked_cumsum_kernel[grid](\n            output_flat_padded, x_flat_padded, mask_flat_padded, n_cols, \n            x_flat_padded.stride(0), BLOCK_SIZE\n        )\n        \n        output_flat = output_flat_padded[:, :n_cols]\n        output = output_flat.view(original_shape[:dim] + (n_cols,) + original_shape[dim+1:])\n        return output.moveaxis(-1, dim)\n\nbatch_size = 128\ninput_shape = (4000,)\ndim = 1\n\ndef get_inputs():\n    x = torch.randn(batch_size, *input_shape)\n    mask = torch.randint(0, 2, x.shape).bool()\n    return [x, mask]\n\ndef get_init_inputs():\n    return [dim]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "44ca9f19-e0d1-4988-8ed7-2e0602156f9e", "generation": 1, "timestamp": 1754986790.0046022, "iteration_found": 4, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.216, "runtime_ms": 0.109, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:2", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0235, "speed_up": 0.216, "custom_timing": 0.109}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.0334, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:4", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0235, "speed_up": 0.704, "custom_timing": 0.0334}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}