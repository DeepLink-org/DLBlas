{"id": "e34ba1e0-6d28-4ce3-9956-d55d795785d8", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef reduce_spatial(\n    x_ptr,\n    out_ptr,\n    spatial_size,\n    n_channels,\n    n_batches,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid_batch = tl.program_id(0)\n    pid_channel = tl.program_id(1)\n    base = pid_batch * n_channels * spatial_size + pid_channel * spatial_size\n    total = 0.0\n    for offset in range(0, spatial_size, BLOCK_SIZE):\n        idx = offset + tl.arange(0, BLOCK_SIZE)\n        mask = idx < spatial_size\n        data = tl.load(x_ptr + base + idx, mask=mask, other=0.0)\n        total += tl.sum(data, axis=0)\n    out_index = pid_batch * n_channels + pid_channel\n    tl.store(out_ptr + out_index, total)\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size, scale_factor, eps=1e-5, momentum=0.1):\n        super(ModelNew, self).__init__()\n        self.conv_transpose = nn.ConvTranspose3d(in_channels, out_channels, kernel_size)\n        self.scale_factor = scale_factor\n        self.batch_norm = nn.BatchNorm3d(out_channels, eps=eps, momentum=momentum)\n        self.kernel_size = kernel_size\n        self.kernel_sum = None\n        self.bias_fused = None\n\n    def forward(self, x):\n        if self.kernel_sum is None:\n            conv_weight = self.conv_transpose.weight\n            conv_bias = self.conv_transpose.bias\n            bn_gamma = self.batch_norm.weight\n            bn_beta = self.batch_norm.bias\n            bn_mean = self.batch_norm.running_mean\n            bn_var = self.batch_norm.running_var\n            eps = self.batch_norm.eps\n\n            inv_std = 1.0 / torch.sqrt(bn_var + eps)\n            fused_weight = bn_gamma[None, :, None, None, None] * inv_std[None, :, None, None, None] * self.scale_factor * conv_weight\n            self.kernel_sum = fused_weight.sum(dim=(2,3,4))\n\n            if conv_bias is None:\n                conv_bias = torch.zeros_like(bn_mean)\n            self.bias_fused = bn_gamma * inv_std * (conv_bias * self.scale_factor - bn_mean) + bn_beta\n\n            self.register_buffer('kernel_sum', self.kernel_sum)\n            self.register_buffer('bias_fused', self.bias_fused)\n\n        batch_size, in_channels, depth, height, width = x.shape\n        if isinstance(self.kernel_size, int):\n            kd = kh = kw = self.kernel_size\n        else:\n            kd, kh, kw = self.kernel_size\n\n        total_elements = (depth + kd - 1) * (height + kh - 1) * (width + kw - 1)\n        x_flat = x.contiguous().view(batch_size, in_channels, -1)\n        spatial_size = x_flat.size(2)\n        input_spatial_sum = torch.empty((batch_size, in_channels), device=x.device, dtype=x.dtype)\n        \n        grid = (batch_size, in_channels)\n        reduce_spatial[grid](x_flat, input_spatial_sum, spatial_size, in_channels, batch_size, BLOCK_SIZE=1024)\n        \n        output_value = torch.matmul(input_spatial_sum, self.kernel_sum)\n        output_value += self.bias_fused * total_elements\n        output_value /= total_elements\n        return output_value.view(batch_size, -1, 1, 1, 1)\n\nbatch_size = 16\nin_channels = 64\nout_channels = 32\ndepth, height, width = 16, 32, 32\nkernel_size = 3\nscale_factor = 2.0\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_channels, depth, height, width)]\n\ndef get_init_inputs():\n    return [in_channels, out_channels, kernel_size, scale_factor]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "31faae04-196b-4cf6-a089-ec1f5d04fcf2", "generation": 1, "timestamp": 1754579172.8958833, "iteration_found": 3, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_77_ConvTranspose3d_Scale_BatchNorm_GlobalAvgPool", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp21hwdy07.py\", line 56, in forward\n    self.register_buffer('kernel_sum', self.kernel_sum)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 570, in register_buffer\n    raise KeyError(f\"attribute '{name}' already exists\")\nKeyError: \"attribute 'kernel_sum' already exists\"\n", "runtime_error_name": "builtins.KeyError", "reference_timing_ms": 0.115, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 1.64, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:2", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.115, "speed_up": 0.07, "custom_timing": 1.64}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}