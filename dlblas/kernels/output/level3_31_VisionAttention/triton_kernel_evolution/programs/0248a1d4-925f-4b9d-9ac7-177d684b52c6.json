{"id": "0248a1d4-925f-4b9d-9ac7-177d684b52c6", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _attention_kernel(\n    Q, K, V, Out,\n    stride_qb, stride_qh, stride_qm, stride_qd,\n    stride_kb, stride_kh, stride_kn, stride_kd,\n    stride_vb, stride_vh, stride_vn, stride_vd,\n    stride_ob, stride_oh, stride_om, stride_od,\n    seq_len,\n    head_dim: tl.constexpr,\n    BLOCK_M: tl.constexpr, BLOCK_N: tl.constexpr\n):\n    pid_b = tl.program_id(0)\n    pid_h = tl.program_id(1)\n    pid_m = tl.program_id(2)\n    \n    offs_m = pid_m * BLOCK_M + tl.arange(0, BLOCK_M)\n    offs_d = tl.arange(0, head_dim)\n    \n    # Load Q block once (outside the loop)\n    q_ptrs = Q + pid_b * stride_qb + pid_h * stride_qh + (offs_m[:, None] * stride_qm + offs_d[None, :] * stride_qd)\n    mask_q = offs_m[:, None] < seq_len\n    q = tl.load(q_ptrs, mask=mask_q, other=0.0)\n    \n    # Initialize statistics and accumulator\n    m_i = tl.zeros((BLOCK_M,), dtype=tl.float32) - float(\"inf\")\n    l_i = tl.zeros((BLOCK_M,), dtype=tl.float32)\n    acc = tl.zeros((BLOCK_M, head_dim), dtype=tl.float32)\n    \n    scale = 1.0 / tl.sqrt(tl.constexpr(head_dim * 1.0))\n    \n    for block_n in range(0, tl.cdiv(seq_len, BLOCK_N)):\n        offs_n = block_n * BLOCK_N + tl.arange(0, BLOCK_N)\n        mask_n = offs_n < seq_len\n        \n        # Load K and V blocks\n        k_ptrs = K + pid_b * stride_kb + pid_h * stride_kh + (offs_n[:, None] * stride_kn + offs_d[None, :] * stride_kd)\n        v_ptrs = V + pid_b * stride_vb + pid_h * stride_vh + (offs_n[:, None] * stride_vn + offs_d[None, :] * stride_vd)\n        \n        k = tl.load(k_ptrs, mask=mask_n[:, None], other=0.0)\n        v = tl.load(v_ptrs, mask=mask_n[:, None], other=0.0)\n        \n        # Compute QK^T with proper transpose\n        qk = tl.dot(q, tl.trans(k)) * scale\n        \n        # Apply combined mask for Q and K\n        mask = mask_q & mask_n[None, :]\n        qk = tl.where(mask, qk, float('-inf'))\n        \n        # Online softmax update\n        m_ij = tl.max(qk, axis=1)\n        m_i_new = tl.maximum(m_i, m_ij)\n        \n        factor_old = tl.exp(m_i - m_i_new)\n        p_ij = tl.exp(qk - m_i_new[:, None])\n        \n        acc = acc * factor_old[:, None]\n        l_i = l_i * factor_old\n        \n        l_ij = tl.sum(p_ij, axis=1)\n        acc += tl.dot(p_ij, v)\n        \n        m_i = m_i_new\n        l_i += l_ij\n    \n    # Normalize and store output\n    acc = acc / l_i[:, None]\n    acc = acc.to(Q.dtype.element_ty)\n    out_ptrs = Out + pid_b * stride_ob + pid_h * stride_oh + (offs_m[:, None] * stride_om + offs_d[None, :] * stride_od)\n    tl.store(out_ptrs, acc, mask=mask_q)\n\nclass ModelNew(nn.Module):\n    def __init__(self, embed_dim, num_heads):\n        super(ModelNew, self).__init__()\n        self.embed_dim = embed_dim\n        self.num_heads = num_heads\n        self.head_dim = embed_dim // num_heads\n        \n        self.q_proj = nn.Linear(embed_dim, embed_dim)\n        self.k_proj = nn.Linear(embed_dim, embed_dim)\n        self.v_proj = nn.Linear(embed_dim, embed_dim)\n        self.out_proj = nn.Linear(embed_dim, embed_dim)\n        self.norm = nn.LayerNorm(embed_dim)\n\n    def forward(self, x):\n        B, C, H, W = x.shape\n        L = H * W\n        x_reshaped = x.view(B, C, L).permute(2, 0, 1)\n        \n        q = self.q_proj(x_reshaped)\n        k = self.k_proj(x_reshaped)\n        v = self.v_proj(x_reshaped)\n        \n        q = q.view(L, B, self.num_heads, self.head_dim).permute(1, 2, 0, 3)\n        k = k.view(L, B, self.num_heads, self.head_dim).permute(1, 2, 0, 3)\n        v = v.view(L, B, self.num_heads, self.head_dim).permute(1, 2, 0, 3)\n        \n        out = torch.empty_like(q)\n        \n        BLOCK_M = 64\n        BLOCK_N = 32\n        grid = (B, self.num_heads, triton.cdiv(L, BLOCK_M))\n        \n        _attention_kernel[grid](\n            q, k, v, out,\n            q.stride(0), q.stride(1), q.stride(2), q.stride(3),\n            k.stride(0), k.stride(1), k.stride(2), k.stride(3),\n            v.stride(0), v.stride(1), v.stride(2), v.stride(3),\n            out.stride(0), out.stride(1), out.stride(2), out.stride(3),\n            L,\n            self.head_dim,\n            BLOCK_M=BLOCK_M, BLOCK_N=BLOCK_N\n        )\n        \n        out = out.permute(2, 0, 1, 3).reshape(L, B, C)\n        out = self.out_proj(out)\n        out = self.norm(out + x_reshaped)\n        out = out.permute(1, 2, 0).view(B, C, H, W)\n        \n        return out\n\nembed_dim = 128\nnum_heads = 4\nbatch_size = 2\nnum_channels = embed_dim\nimage_height = 128\nimage_width = 128\n\ndef get_inputs():\n    return [torch.randn(batch_size, num_channels, image_height, image_width)]\n\ndef get_init_inputs():\n    return [embed_dim, num_heads]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "b8ac4098-c3ab-4370-bec8-4cd0faf4bb97", "generation": 3, "timestamp": 1754595130.1830986, "iteration_found": 13, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_31_VisionAttention", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "max_difference": ["0.238592", "0.247373", "0.242119", "0.270904", "0.239257"], "avg_difference": ["0.056394", "0.056733", "0.056066", "0.056213", "0.055577"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 0.335, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_31_VisionAttention", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "max_difference": ["nan", "nan", "nan", "nan", "nan"], "avg_difference": ["nan", "nan", "nan", "nan", "nan"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 0.335, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}