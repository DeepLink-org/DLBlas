{"id": "0360855e-4110-4d71-a6d7-139fd5838518", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\nimport math\n\n@triton.autotune(\n    configs=[\n        triton.Config({'BLOCK_SIZE_BATCH': 64, 'BLOCK_SIZE_FEAT': 64, 'BLOCK_SIZE_K': 64}, num_warps=4, num_stages=3),\n        triton.Config({'BLOCK_SIZE_BATCH': 128, 'BLOCK_SIZE_FEAT': 64, 'BLOCK_SIZE_K': 64}, num_warps=4, num_stages=3),\n        triton.Config({'BLOCK_SIZE_BATCH': 64, 'BLOCK_SIZE_FEAT': 128, 'BLOCK_SIZE_K': 64}, num_warps=8, num_stages=3),\n        triton.Config({'BLOCK_SIZE_BATCH': 128, 'BLOCK_SIZE_FEAT': 128, 'BLOCK_SIZE_K': 64}, num_warps=8, num_stages=3),\n    ],\n    key=['batch_size', 'in_features', 'out_features'],\n)\n@triton.jit\ndef linear_kernel(\n    x_ptr, weight_ptr, bias_ptr, output_ptr,\n    batch_size, in_features, out_features,\n    stride_xb, stride_xm,\n    stride_wn, stride_wm,\n    stride_outb, stride_outn,\n    BLOCK_SIZE_BATCH: tl.constexpr,\n    BLOCK_SIZE_FEAT: tl.constexpr,\n    BLOCK_SIZE_K: tl.constexpr,\n):\n    pid0 = tl.program_id(0)\n    pid1 = tl.program_id(1)\n    \n    batch_offsets = pid0 * BLOCK_SIZE_BATCH + tl.arange(0, BLOCK_SIZE_BATCH)\n    feat_offsets = pid1 * BLOCK_SIZE_FEAT + tl.arange(0, BLOCK_SIZE_FEAT)\n    k_offsets = tl.arange(0, BLOCK_SIZE_K)\n    \n    batch_mask = batch_offsets < batch_size\n    feat_mask = feat_offsets < out_features\n    \n    acc = tl.zeros((BLOCK_SIZE_BATCH, BLOCK_SIZE_FEAT), dtype=tl.float32)\n    \n    for k in range(0, in_features, BLOCK_SIZE_K):\n        k_current = k + k_offsets\n        k_mask = k_current < in_features\n        \n        # Load input block\n        x_ptrs = x_ptr + (batch_offsets[:, None] * stride_xb + k_current[None, :] * stride_xm)\n        x_mask = batch_mask[:, None] & k_mask[None, :]\n        x_block = tl.load(x_ptrs, mask=x_mask, other=0.0)\n        \n        # Load weight block\n        w_ptrs = weight_ptr + (feat_offsets[:, None] * stride_wn + k_current[None, :] * stride_wm)\n        w_mask = feat_mask[:, None] & k_mask[None, :]\n        w_block = tl.load(w_ptrs, mask=w_mask, other=0.0)\n        \n        # Convert to FP16 for tensor core operation\n        x_block_f16 = x_block.to(tl.float16)\n        w_block_f16 = w_block.to(tl.float16)\n        \n        # Tensor core matrix multiplication\n        acc += tl.dot(x_block_f16, w_block_f16, out_dtype=tl.float32)\n    \n    # Load and add bias\n    b_ptrs = bias_ptr + feat_offsets\n    b_block = tl.load(b_ptrs, mask=feat_mask, other=0.0)\n    acc += b_block[None, :]\n    \n    # Store output\n    out_ptrs = output_ptr + (batch_offsets[:, None] * stride_outb + feat_offsets[None, :] * stride_outn)\n    tl.store(out_ptrs, acc, mask=batch_mask[:, None] & feat_mask[None, :])\n\ndef linear_triton(x, weight, bias):\n    B, M = x.shape\n    N = weight.shape[0]\n    output = torch.empty(B, N, device=x.device, dtype=x.dtype)\n    \n    grid = lambda meta: (\n        triton.cdiv(B, meta['BLOCK_SIZE_BATCH']),\n        triton.cdiv(N, meta['BLOCK_SIZE_FEAT']),\n    )\n    \n    linear_kernel[grid](\n        x, weight, bias, output,\n        B, M, N,\n        x.stride(0), x.stride(1),\n        weight.stride(0), weight.stride(1),\n        output.stride(0), output.stride(1),\n    )\n    return output\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_features, out_features, dropout_p):\n        super(ModelNew, self).__init__()\n        self.in_features = in_features\n        self.out_features = out_features\n        self.weight = nn.Parameter(torch.empty(out_features, in_features))\n        self.bias = nn.Parameter(torch.empty(out_features))\n        self.dropout = nn.Dropout(dropout_p)\n        nn.init.kaiming_uniform_(self.weight, a=math.sqrt(5))\n        if self.bias is not None:\n            fan_in, _ = nn.init._calculate_fan_in_and_fan_out(self.weight)\n            bound = 1 / math.sqrt(fan_in) if fan_in > 0 else 0\n            nn.init.uniform_(self.bias, -bound, bound)\n    \n    def forward(self, x):\n        x = linear_triton(x, self.weight, self.bias)\n        x = self.dropout(x)\n        x = torch.mean(x, dim=1, keepdim=True)\n        x = torch.softmax(x, dim=1)\n        return x\n\nbatch_size = 128\nin_features = 100\nout_features = 50\ndropout_p = 0.2\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_features)]\n\ndef get_init_inputs():\n    return [in_features, out_features, dropout_p]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "80511888-874a-4129-aebf-81da3b4f8e85", "generation": 2, "timestamp": 1754584018.47967, "iteration_found": 17, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_66_Matmul_Dropout_Mean_Softmax", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "runtime_error": "Traceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 2045, in dot\n    return _semantic.dot(input, other, acc, input_precision, max_num_imprecise_acc, out_dtype)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 1498, in dot\n    assert lhs.shape[-1].value == rhs.shape[\nAssertionError: First input shape (['constexpr[64]', 'constexpr[64]']) and second input shape ['constexpr[128]', 'constexpr[64]'] are not compatible for matmul (second index of first shape (64) must be equal to first index of second shape (128)\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp29i3f6ue.py\", line 104, in forward\n    x = linear_triton(x, self.weight, self.bias)\n  File \"/tmp/tmp29i3f6ue.py\", line 80, in linear_triton\n    linear_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 239, in run\n    benchmark()\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 228, in benchmark\n    timings = {config: self._bench(*args, config=config, **kwargs) for config in pruned_configs}\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 228, in <dictcomp>\n    timings = {config: self._bench(*args, config=config, **kwargs) for config in pruned_configs}\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 160, in _bench\n    return self.do_bench(kernel_call, quantiles=(0.5, 0.2, 0.8))\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/testing.py\", line 149, in do_bench\n    fn()\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/autotuner.py\", line 146, in kernel_call\n    self.fn.run(\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 42:15:\n\n        # Load weight block\n        w_ptrs = weight_ptr + (feat_offsets[:, None] * stride_wn + k_current[None, :] * stride_wm)\n        w_mask = feat_mask[:, None] & k_mask[None, :]\n        w_block = tl.load(w_ptrs, mask=w_mask, other=0.0)\n\n        # Convert to FP16 for tensor core operation\n        x_block_f16 = x_block.to(tl.float16)\n        w_block_f16 = w_block.to(tl.float16)\n\n        # Tensor core matrix multiplication\n        acc += tl.dot(x_block_f16, w_block_f16, out_dtype=tl.float32)\n               ^\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 2045, in dot\n    return _semantic.dot(input, other, acc, input_precision, max_num_imprecise_acc, out_dtype)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 1498, in dot\n    assert lhs.shape[-1].value == rhs.shape[\nAssertionError: First input shape (['constexpr[64]', 'constexpr[64]']) and second input shape ['constexpr[128]', 'constexpr[64]'] are not compatible for matmul (second index of first shape (64) must be equal to first index of second shape (128)\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.0715, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.856, "runtime_ms": 0.0835, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0715, "speed_up": 0.856, "custom_timing": 0.0835}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}