{"id": "41696551-f94d-4302-b819-2085fdeecd55", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _instance_norm_kernel(\n    x_ptr,\n    output_ptr,\n    stride_n, stride_c, stride_h, stride_w,\n    H, W,\n    eps: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    num_features = tl.num_programs(1)\n    sample_idx = pid\n    feature_idx = tl.program_id(1)\n    \n    base_ptr = x_ptr + sample_idx * stride_n + feature_idx * stride_c\n    total_elements = H * W\n    \n    # Initialize accumulators\n    mean_acc = 0.0\n    m2_acc = 0.0\n    count = 0.0\n    \n    # Compute mean and variance using Welford's algorithm\n    for offset in range(0, total_elements, BLOCK_SIZE):\n        idx = offset + tl.arange(0, BLOCK_SIZE)\n        mask = idx < total_elements\n        \n        # Calculate 2D indices\n        h_idx = idx // W\n        w_idx = idx % W\n        x_offset = base_ptr + h_idx * stride_h + w_idx * stride_w\n        \n        # Load data\n        x_val = tl.load(x_offset, mask=mask, other=0.0)\n        \n        # Online mean and variance update\n        for val in tl.static_range(BLOCK_SIZE):\n            if mask[val]:\n                count += 1.0\n                delta1 = x_val[val] - mean_acc\n                mean_acc += delta1 / count\n                delta2 = x_val[val] - mean_acc\n                m2_acc += delta1 * delta2\n    \n    # Final variance calculation\n    variance = m2_acc / total_elements\n    inv_std = 1.0 / tl.sqrt(variance + eps)\n    \n    # Normalize and store results\n    for offset in range(0, total_elements, BLOCK_SIZE):\n        idx = offset + tl.arange(0, BLOCK_SIZE)\n        mask = idx < total_elements\n        \n        h_idx = idx // W\n        w_idx = idx % W\n        x_offset = base_ptr + h_idx * stride_h + w_idx * stride_w\n        out_offset = output_ptr + sample_idx * stride_n + feature_idx * stride_c + h_idx * stride_h + w_idx * stride_w\n        \n        x_val = tl.load(x_offset, mask=mask, other=0.0)\n        normalized = (x_val - mean_acc) * inv_std\n        tl.store(out_offset, normalized, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_features: int):\n        super(ModelNew, self).__init__()\n        self.num_features = num_features\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        x = x.contiguous()\n        output = torch.empty_like(x)\n        B, C, H, W = x.shape\n        \n        # Configure kernel\n        grid = lambda meta: (B, C)\n        BLOCK_SIZE = 1024\n        \n        # Launch kernel\n        _instance_norm_kernel[grid](\n            x, output,\n            x.stride(0), x.stride(1), x.stride(2), x.stride(3),\n            H, W,\n            eps=1e-5,\n            BLOCK_SIZE=BLOCK_SIZE\n        )\n        return output\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [features]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "0784059a-6a77-456b-a07c-c87f81ba2ae6", "generation": 1, "timestamp": 1754635336.744025, "iteration_found": 3, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level1_34_InstanceNorm", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:0", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpkg1gvubf.py\", line 84, in forward\n    _instance_norm_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 37:15:\n\n        # Calculate 2D indices\n        h_idx = idx // W\n        w_idx = idx % W\n        x_offset = base_ptr + h_idx * stride_h + w_idx * stride_w\n\n        # Load data\n        x_val = tl.load(x_offset, mask=mask, other=0.0)\n\n        # Online mean and variance update\n        for val in tl.static_range(BLOCK_SIZE):\n            if mask[val]:\n               ^\nValueError('unsupported tensor index: constexpr[0]')\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1118, in __getitem__\n    raise ValueError(f\"unsupported tensor index: {sl}\")\nValueError: unsupported tensor index: constexpr[0]\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.043, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.377, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.043, "speed_up": 0.114, "custom_timing": 0.377}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}