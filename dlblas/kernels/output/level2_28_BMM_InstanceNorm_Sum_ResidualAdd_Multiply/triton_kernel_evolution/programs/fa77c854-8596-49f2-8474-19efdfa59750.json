{"id": "fa77c854-8596-49f2-8474-19efdfa59750", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _forward_kernel(\n    x_ptr, y_ptr, output_ptr,\n    w_ptr, linear_bias_ptr,\n    running_mean_ptr, running_var_ptr,\n    gamma_ptr, beta_ptr,\n    sum_feature_ptr,\n    in_features, out_features,\n    stride_x_batch, stride_x_feature,\n    stride_y_batch, stride_y_feature,\n    stride_w_feature, stride_w_in,\n    training: tl.constexpr, \n    eps: tl.constexpr,\n    BLOCK_IN: tl.constexpr\n):\n    pid0 = tl.program_id(0)  # Batch index\n    pid1 = tl.program_id(1)  # Feature index\n\n    # Compute linear transformation\n    dot = 0.0\n    for k in range(0, in_features, BLOCK_IN):\n        k_offs = k + tl.arange(0, BLOCK_IN)\n        mask = k_offs < in_features\n        \n        x_val = tl.load(x_ptr + pid0 * stride_x_batch + k_offs * stride_x_feature, mask=mask)\n        w_val = tl.load(w_ptr + pid1 * stride_w_feature + k_offs * stride_w_in, mask=mask)\n        dot += tl.sum(x_val * w_val, axis=0)\n    \n    linear_out = dot + tl.load(linear_bias_ptr + pid1)\n\n    # Training vs inference logic\n    if training:\n        tl.atomic_add(sum_feature_ptr + pid1, linear_out)\n        normalized = tl.load(beta_ptr + pid1)\n    else:\n        running_mean = tl.load(running_mean_ptr + pid1)\n        running_var = tl.load(running_var_ptr + pid1)\n        gamma = tl.load(gamma_ptr + pid1)\n        beta_val = tl.load(beta_ptr + pid1)\n        normalized = gamma * ( (linear_out - running_mean) / tl.sqrt(running_var + eps) ) + beta_val\n\n    # Pointwise operations\n    y_val = tl.load(y_ptr + pid0 * stride_y_batch + pid1 * stride_y_feature)\n    out = (normalized + y_val) * y_val\n    tl.store(output_ptr + pid0 * out_features + pid1, out)\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_features, out_features, eps=1e-5, momentum=0.1):\n        super(ModelNew, self).__init__()\n        self.bmm = nn.Linear(in_features, out_features)\n        self.instance_norm = nn.InstanceNorm2d(out_features, eps=eps, momentum=momentum)\n        self.eps = eps\n        self.momentum = momentum\n\n    def forward(self, x, y):\n        batch_size, out_features = x.shape[0], self.bmm.out_features\n        \n        # Ensure contiguous tensors\n        x = x.contiguous()\n        y = y.contiguous()\n        output = torch.empty(batch_size, out_features, device=x.device, dtype=x.dtype)\n        \n        # Setup reduction buffer for training\n        if self.training:\n            sum_feature = torch.zeros(out_features, device=x.device, dtype=torch.float32)\n        else:\n            sum_feature = torch.empty(0, device=x.device)  # Dummy tensor\n            \n        # Launch kernel\n        grid = (batch_size, out_features)\n        _forward_kernel[grid](\n            x, y, output,\n            self.bmm.weight, self.bmm.bias,\n            self.instance_norm.running_mean, self.instance_norm.running_var,\n            self.instance_norm.weight, self.instance_norm.bias,\n            sum_feature,\n            in_features, out_features,\n            x.stride(0), x.stride(1),\n            y.stride(0), y.stride(1),\n            self.bmm.weight.stride(0), self.bmm.weight.stride(1),\n            training=self.training,\n            eps=self.eps,\n            BLOCK_IN=64\n        )\n        \n        # Update running stats if training\n        if self.training:\n            mean_feature = sum_feature / batch_size\n            self.instance_norm.running_mean = (\n                (1 - self.momentum) * self.instance_norm.running_mean + \n                self.momentum * mean_feature\n            )\n            self.instance_norm.running_var = (\n                (1 - self.momentum) * self.instance_norm.running_var\n            )  # Variance is zero in this case\n            \n        return output\n\nbatch_size = 128\nin_features = 64\nout_features = 128\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_features), torch.randn(batch_size, out_features)]\n\ndef get_init_inputs():\n    return [in_features, out_features]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "0e73fb47-dc77-488f-8563-90352d0b3b9b", "generation": 1, "timestamp": 1754566638.7986517, "iteration_found": 2, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_28_BMM_InstanceNorm_Sum_ResidualAdd_Multiply", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpe_348rqg.py\", line 77, in forward\n    _forward_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 33:29:\n        mask = k_offs < in_features\n\n        x_val = tl.load(x_ptr + pid0 * stride_x_batch + k_offs * stride_x_feature, mask=mask)\n        w_val = tl.load(w_ptr + pid1 * stride_w_feature + k_offs * stride_w_in, mask=mask)\n        dot += tl.sum(x_val * w_val, axis=0)\n\n    linear_out = dot + tl.load(linear_bias_ptr + pid1)\n\n    # Training vs inference logic\n    if training:\n        tl.atomic_add(sum_feature_ptr + pid1, linear_out)\n        normalized = tl.load(beta_ptr + pid1)\n                             ^\nAttributeError(\"'NoneType' object has no attribute 'type'\")\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 904, in __radd__\n    return add(other, self, sanitize_overflow=True, _semantic=_semantic)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 2468, in add\n    return _semantic.add(x, y, sanitize_overflow)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 226, in add\n    input, other = self.binary_op_type_checking_impl(input, other, True, True)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 182, in binary_op_type_checking_impl\n    lhs_sca_ty = lhs.type.scalar\nAttributeError: 'NoneType' object has no attribute 'type'\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.0981, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.128, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0981, "speed_up": 0.766, "custom_timing": 0.128}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}