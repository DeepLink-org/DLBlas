{"id": "55169eff-108a-4b7b-8e10-9fe6315b5fa5", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef fused_add_layernorm_gelu_kernel(\n    x_ptr,\n    output_ptr,\n    weight_ptr,\n    bias_ptr,\n    scalar,\n    n_elements,\n    C,\n    D, H, W,\n    stride_b, stride_c, stride_d, stride_h, stride_w,\n    eps: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    if pid >= n_elements:\n        return\n    \n    # Compute indices\n    idx = pid\n    w_idx = idx % W\n    h_idx = (idx // W) % H\n    d_idx = (idx // (H * W)) % D\n    b_idx = idx // (D * H * W)\n    \n    # Base pointer for the current spatial position\n    base = b_idx * stride_b + d_idx * stride_d + h_idx * stride_h + w_idx * stride_w\n    \n    # Load channel vector for this position\n    c_offsets = base + tl.arange(0, BLOCK_SIZE) * stride_c\n    mask = tl.arange(0, BLOCK_SIZE) < C\n    x = tl.load(x_ptr + c_offsets, mask=mask, other=0.0)\n    \n    # Add scalar\n    x += scalar\n    \n    # Compute mean and variance\n    mean = tl.sum(x, axis=0) / C\n    x_centered = x - mean\n    var = tl.sum(x_centered * x_centered, axis=0) / C + eps\n    inv_std = 1.0 / tl.sqrt(var)\n    \n    # Normalize and affine transform\n    normalized = x_centered * inv_std\n    weight = tl.load(weight_ptr + tl.arange(0, BLOCK_SIZE), mask=mask)\n    bias = tl.load(bias_ptr + tl.arange(0, BLOCK_SIZE), mask=mask)\n    out = normalized * weight + bias\n    \n    # Apply GELU approximation\n    out = out * 0.5 * (1.0 + tl.erf(out * 0.7071067811865475))\n    \n    # Store result\n    tl.store(output_ptr + c_offsets, out, mask=mask)\n\ndef fused_add_layernorm_gelu(x, scalar, weight, bias):\n    batch, C, D, H, W = x.shape\n    n_elements = batch * D * H * W\n    output = torch.empty_like(x)\n    \n    # Launch kernel\n    grid = (n_elements,)\n    fused_add_layernorm_gelu_kernel[grid](\n        x, output, weight, bias, scalar.item(),\n        n_elements, C, D, H, W,\n        x.stride(0), x.stride(1), x.stride(2), x.stride(3), x.stride(4),\n        eps=1e-5,\n        BLOCK_SIZE=triton.next_power_of_2(C)\n    )\n    return output\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size, stride, padding, output_padding, sum_weight, norm_shape, pool_kernel_size):\n        super(ModelNew, self).__init__()\n        self.conv_transpose = nn.ConvTranspose3d(in_channels, out_channels, kernel_size, stride=stride, padding=padding, output_padding=output_padding)\n        self.sum_weight = nn.Parameter(torch.tensor(sum_weight))\n        self.norm = nn.LayerNorm(norm_shape)\n        self.avg_pool = nn.AvgPool3d(kernel_size=pool_kernel_size)\n        \n    def forward(self, x):\n        x = self.conv_transpose(x)\n        x = fused_add_layernorm_gelu(x, self.sum_weight, self.norm.weight, self.norm.bias)\n        x = self.avg_pool(x)\n        return x\n\nbatch_size = 128\nin_channels = 32\nout_channels = 64\ndepth, height, width = 16, 32, 32\nkernel_size = (3, 3, 3)\nstride = (2, 2, 2)\npadding = (1, 1, 1)\noutput_padding = (1, 1, 1)\nsum_weight = 1.0\nnorm_shape = (out_channels,)\npool_kernel_size = (2, 2, 2)\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_channels, depth, height, width)]\n\ndef get_init_inputs():\n    return [in_channels, out_channels, kernel_size, stride, padding, output_padding, sum_weight, norm_shape, pool_kernel_size]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "4a4670a6-187a-4032-ae43-d0e7ae17aecc", "generation": 1, "timestamp": 1754573331.4305334, "iteration_found": 3, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_3_ConvTranspose3d_Sum_LayerNorm_AvgPool_GELU", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "max_difference": ["1.258094", "1.209493", "1.198649", "1.235300", "1.212177"], "avg_difference": ["0.239825", "0.239821", "0.239828", "0.239832", "0.239828"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 0.167, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 40.0, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:1", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.167, "speed_up": 0.004, "custom_timing": 40.0}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}