{"id": "0225fbe3-faea-44b5-921e-1949c3f62ad5", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef triplet_margin_kernel(\n    anchor_ptr, positive_ptr, negative_ptr, output_ptr,\n    n_triplets, feature_size, margin,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    if pid >= n_triplets:\n        return\n    \n    ap_acc = 0.0\n    an_acc = 0.0\n    \n    for offset in range(0, feature_size, BLOCK_SIZE):\n        idxs = tl.arange(0, BLOCK_SIZE)\n        mask = idxs < (feature_size - offset)\n        \n        a = tl.load(anchor_ptr + pid * feature_size + offset + idxs, mask=mask, other=0.0)\n        p = tl.load(positive_ptr + pid * feature_size + offset + idxs, mask=mask, other=0.0)\n        n = tl.load(negative_ptr + pid * feature_size + offset + idxs, mask=mask, other=0.0)\n        \n        ap_diff = a - p\n        an_diff = a - n\n        \n        ap_acc += tl.sum(ap_diff * ap_diff)\n        an_acc += tl.sum(an_diff * an_diff)\n    \n    d_ap = tl.sqrt(ap_acc)\n    d_an = tl.sqrt(an_acc)\n    loss = tl.maximum(d_ap - d_an + margin, 0.0)\n    tl.store(output_ptr + pid, loss)\n\nclass ModelNew(nn.Module):\n    def __init__(self, margin=1.0):\n        super().__init__()\n        self.margin = margin\n\n    def forward(self, anchor, positive, negative):\n        n_triplets = anchor.shape[0]\n        feature_size = anchor.shape[1]\n        losses = torch.empty(n_triplets, device=anchor.device)\n        \n        BLOCK_SIZE = 4096  # Optimized block size for 4096 feature dimension\n        grid = (n_triplets,)\n        triplet_margin_kernel[grid](\n            anchor, positive, negative, losses,\n            n_triplets, feature_size, self.margin,\n            BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        return losses.mean()\n\nbatch_size = 128\ninput_shape = (4096,)\ndim = 1\n\ndef get_inputs():\n    return [torch.randn(batch_size, *input_shape), \n            torch.randn(batch_size, *input_shape), \n            torch.randn(batch_size, *input_shape)]\n\ndef get_init_inputs():\n    return [1.0]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "85a87897-46ef-40e5-9f84-9c30afe7a3b4", "generation": 4, "timestamp": 1754997967.0714936, "iteration_found": 22, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": true, "score": 58.39999999999999, "speed_up": 1.384, "runtime_ms": 0.0523, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0724, "speed_up": 1.384, "custom_timing": 0.0523}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": true, "score": 54.3, "speed_up": 1.343, "runtime_ms": 0.0539, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0724, "speed_up": 1.343, "custom_timing": 0.0539}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}