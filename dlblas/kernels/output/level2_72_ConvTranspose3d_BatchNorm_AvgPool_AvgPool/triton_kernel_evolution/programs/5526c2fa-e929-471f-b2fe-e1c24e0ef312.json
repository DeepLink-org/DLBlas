{"id": "5526c2fa-e929-471f-b2fe-e1c24e0ef312", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _fused_avg_pool_3d_4x_kernel(\n    input_ptr,\n    output_ptr,\n    input_n, input_c, input_d, input_h, input_w,\n    output_d, output_h, output_w,\n    stride_n, stride_c, stride_d, stride_h, stride_w,\n    out_stride_n, out_stride_c, out_stride_d, out_stride_h, out_stride_w,\n    n_elements,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    if pid >= n_elements:\n        return\n\n    w = pid % output_w\n    h = (pid // output_w) % output_h\n    d = (pid // (output_w * output_h)) % output_d\n    c = (pid // (output_w * output_h * output_d)) % input_c\n    n = pid // (output_w * output_h * output_d * input_c)\n\n    base = n * stride_n + c * stride_c\n    d_start = d * 4\n    h_start = h * 4\n    w_start = w * 4\n\n    total = 0.0\n    count = 0\n    for dd in range(0, 4):\n        d_in = d_start + dd\n        if d_in < input_d:\n            for hh in range(0, 4):\n                h_in = h_start + hh\n                if h_in < input_h:\n                    for ww in range(0, 4):\n                        w_in = w_start + ww\n                        if w_in < input_w:\n                            offset = base + d_in * stride_d + h_in * stride_h + w_in * stride_w\n                            total += tl.load(input_ptr + offset)\n                            count += 1\n\n    if count > 0:\n        average = total / count\n    else:\n        average = 0.0\n\n    out_offset = n * out_stride_n + c * out_stride_c + d * out_stride_d + h * out_stride_h + w * out_stride_w\n    tl.store(output_ptr + out_offset, average)\n\ndef fused_avg_pool_3d_4x(x: torch.Tensor) -> torch.Tensor:\n    N, C, D, H, W = x.shape\n    output = torch.empty((N, C, D//4, H//4, W//4), device=x.device, dtype=x.dtype)\n    \n    x = x.contiguous()\n    output = output.contiguous()\n    \n    total_elements = output.numel()\n    grid = [total_elements]\n    \n    stride_n, stride_c, stride_d, stride_h, stride_w = x.stride()\n    out_stride_n, out_stride_c, out_stride_d, out_stride_h, out_stride_w = output.stride()\n    \n    _fused_avg_pool_3d_4x_kernel[grid](\n        x, output,\n        N, C, D, H, W,\n        D//4, H//4, W//4,\n        stride_n, stride_c, stride_d, stride_h, stride_w,\n        out_stride_n, out_stride_c, out_stride_d, out_stride_h, out_stride_w,\n        total_elements,\n        BLOCK_SIZE=128,\n    )\n    return output\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size, stride, padding, bias_shape):\n        super(ModelNew, self).__init__()\n        self.conv_transpose = nn.ConvTranspose3d(in_channels, out_channels, kernel_size, stride=stride, padding=padding)\n        self.batch_norm = nn.BatchNorm3d(out_channels)\n\n    def forward(self, x):\n        x = self.conv_transpose(x)\n        x = self.batch_norm(x)\n        x = fused_avg_pool_3d_4x(x)\n        return x\n\nbatch_size = 128\nin_channels = 3\nout_channels = 16\ndepth, height, width = 32, 32, 32\nkernel_size = 3\nstride = 2\npadding = 1\nbias_shape = (out_channels, 1, 1, 1)\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_channels, depth, height, width)]\n\ndef get_init_inputs():\n    return [in_channels, out_channels, kernel_size, stride, padding, bias_shape]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "24890950-ede3-417c-8a65-d2d694c72a9c", "generation": 1, "timestamp": 1754579816.2986689, "iteration_found": 3, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.003, "runtime_ms": 49.8, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:6", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.133, "speed_up": 0.003, "custom_timing": 49.8}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 24.4, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.133, "speed_up": 0.005, "custom_timing": 24.4}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}