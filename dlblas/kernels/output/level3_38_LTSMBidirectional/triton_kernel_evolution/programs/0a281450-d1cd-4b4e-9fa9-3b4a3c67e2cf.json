{"id": "0a281450-d1cd-4b4e-9fa9-3b4a3c67e2cf", "code": "import math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef linear_forward_kernel(\n    x_ptr, w_ptr, b_ptr, y_ptr,\n    n, m, k,\n    stride_x0, stride_x1,\n    stride_w0, stride_w1,\n    stride_y0, stride_y1,\n    BLOCK_M: tl.constexpr, BLOCK_K: tl.constexpr, BLOCK_N: tl.constexpr\n):\n    pid0 = tl.program_id(0)\n    pid1 = tl.program_id(1)\n    \n    # Create block pointers\n    x_block_ptr = tl.make_block_ptr(\n        base=x_ptr,\n        shape=(n, k),\n        strides=(stride_x0, stride_x1),\n        offsets=(pid0 * BLOCK_M, 0),\n        block_shape=(BLOCK_M, BLOCK_K),\n        order=(1, 0)\n    )\n    \n    w_block_ptr = tl.make_block_ptr(\n        base=w_ptr,\n        shape=(m, k),\n        strides=(stride_w0, stride_w1),\n        offsets=(pid1 * BLOCK_N, 0),\n        block_shape=(BLOCK_N, BLOCK_K),\n        order=(1, 0)\n    )\n    \n    y_block_ptr = tl.make_block_ptr(\n        base=y_ptr,\n        shape=(n, m),\n        strides=(stride_y0, stride_y1),\n        offsets=(pid0 * BLOCK_M, pid1 * BLOCK_N),\n        block_shape=(BLOCK_M, BLOCK_N),\n        order=(1, 0)\n    )\n    \n    # Initialize accumulator\n    acc = tl.zeros((BLOCK_M, BLOCK_N), dtype=tl.float32)\n    \n    # Blocked matrix multiplication\n    for i in range(0, tl.cdiv(k, BLOCK_K)):\n        x_block = tl.load(x_block_ptr, boundary_check=(0, 1))\n        w_block = tl.load(w_block_ptr, boundary_check=(0, 1))\n        acc += tl.dot(x_block, w_block, allow_tf32=True)\n        \n        # Update pointers\n        x_block_ptr = tl.advance(x_block_ptr, (0, BLOCK_K))\n        w_block_ptr = tl.advance(w_block_ptr, (0, BLOCK_K))\n    \n    # Add bias\n    if b_ptr is not None:\n        bias = tl.load(b_ptr + tl.arange(0, BLOCK_N) + pid1 * BLOCK_N, \n                      mask=(tl.arange(0, BLOCK_N) + pid1 * BLOCK_N) < m, other=0.0)\n        acc += bias[None, :]\n    \n    # Store result\n    tl.store(y_block_ptr, acc.to(y_ptr.dtype.element_ty), boundary_check=(0, 1))\n\nclass TritonLinear(nn.Module):\n    def __init__(self, in_features, out_features):\n        super().__init__()\n        self.in_features = in_features\n        self.out_features = out_features\n        self.weight = nn.Parameter(torch.Tensor(out_features, in_features))\n        self.bias = nn.Parameter(torch.Tensor(out_features))\n        self.reset_parameters()\n    \n    def reset_parameters(self):\n        nn.init.kaiming_uniform_(self.weight, a=math.sqrt(5))\n        if self.bias is not None:\n            fan_in, _ = nn.init._calculate_fan_in_and_fan_out(self.weight)\n            bound = 1 / math.sqrt(fan_in) if fan_in > 0 else 0\n            nn.init.uniform_(self.bias, -bound, bound)\n    \n    def forward(self, x):\n        y = torch.empty(x.shape[0], self.out_features, device=x.device, dtype=x.dtype)\n        n, k = x.shape\n        m = self.out_features\n        \n        # Tune block sizes for H100 architecture\n        BLOCK_M = 64\n        BLOCK_N = 64\n        BLOCK_K = 64\n        \n        grid = (\n            triton.cdiv(n, BLOCK_M),\n            triton.cdiv(m, BLOCK_N)\n        )\n        \n        linear_forward_kernel[grid](\n            x, self.weight, self.bias, y,\n            n, m, k,\n            x.stride(0), x.stride(1),\n            self.weight.stride(0), self.weight.stride(1),\n            y.stride(0), y.stride(1),\n            BLOCK_M=BLOCK_M, BLOCK_K=BLOCK_K, BLOCK_N=BLOCK_N\n        )\n        return y\n\nclass ModelNew(nn.Module):\n    def __init__(self, input_size, hidden_size, num_layers, output_size, dropout=0.0):\n        super(ModelNew, self).__init__()\n        self.hidden_size = hidden_size\n        self.num_layers = num_layers\n        self.lstm = nn.LSTM(\n            input_size, hidden_size, num_layers, \n            batch_first=True, dropout=dropout, bidirectional=True\n        )\n        self.fc = TritonLinear(hidden_size * 2, output_size)\n    \n    def forward(self, x):\n        batch_size = x.size(0)\n        h0 = torch.zeros(self.num_layers * 2, batch_size, self.hidden_size, device=x.device)\n        c0 = torch.zeros(self.num_layers * 2, batch_size, self.hidden_size, device=x.device)\n        out, _ = self.lstm(x, (h0, c0))\n        out = self.fc(out[:, -1, :])\n        return out", "language": "python", "parent_id": "8954e9b3-ea9a-46d9-b19f-24c756cc2b8a", "generation": 3, "timestamp": 1754593206.0949016, "iteration_found": 22, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_38_LTSMBidirectional", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "max_difference": ["0.289905", "0.289961", "0.289797", "0.289905", "0.289464"], "avg_difference": ["0.079079", "0.079012", "0.079034", "0.079094", "0.079034"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 42.6, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_38_LTSMBidirectional", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:6", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpdrl5xhb9.py\", line 203, in forward\n    out, _ = bidirectional_lstm_triton(\n  File \"/tmp/tmpdrl5xhb9.py\", line 152, in bidirectional_lstm_triton\n    lstm_forward_kernel[(batch_size,)](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 281, in compile\n    key = f\"{triton_key()}-{src.hash()}-{backend.hash()}-{options.hash()}-{str(sorted(env_vars.items()))}\"\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 78, in hash\n    key = f\"{self.fn.cache_key}-{str(self.attrs)}-{sorted_sig}-{constants_key}\"\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 696, in cache_key\n    dependencies_finder.visit(self.parse())\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 426, in generic_visit\n    self.visit(item)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 163, in visit_FunctionDef\n    self.generic_visit(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 426, in generic_visit\n    self.visit(item)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 229, in visit_For\n    self.generic_visit(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 426, in generic_visit\n    self.visit(item)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 217, in visit_Assign\n    self.generic_visit(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 428, in generic_visit\n    self.visit(value)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 428, in generic_visit\n    self.visit(value)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 156, in visit_Attribute\n    ret = getattr(lhs, node.attr)\nAttributeError: module 'triton.language' has no attribute 'tanh'\n", "runtime_error_name": "builtins.AttributeError", "reference_timing_ms": 42.6, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}