{"id": "963b9765-3d5a-4a07-81d4-75675c4ca60a", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _gemm_kernel(\n    x_ptr, w_ptr, bias_ptr, out_ptr,\n    M, N, K,\n    stride_xm, stride_xk,\n    stride_wn, stride_wk,\n    stride_out_m, stride_out_n,\n    BLOCK_M: tl.constexpr, BLOCK_N: tl.constexpr, BLOCK_K: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    num_pid_m = tl.cdiv(M, BLOCK_M)\n    num_pid_n = tl.cdiv(N, BLOCK_N)\n    pid_m = pid // num_pid_n\n    pid_n = pid % num_pid_n\n\n    offs_m = pid_m * BLOCK_M + tl.arange(0, BLOCK_M)\n    offs_n = pid_n * BLOCK_N + tl.arange(0, BLOCK_N)\n    offs_k = tl.arange(0, BLOCK_K)\n\n    x_ptr += offs_m[:, None] * stride_xm + offs_k[None, :] * stride_xk\n    w_ptr += offs_n[:, None] * stride_wn + offs_k[None, :] * stride_wk\n\n    acc = tl.zeros((BLOCK_M, BLOCK_N), dtype=tl.float32)\n\n    for k in range(0, K, BLOCK_K):\n        k_remaining = K - k\n        k_mask = offs_k[None, :] < k_remaining\n        x_val = tl.load(x_ptr, mask=k_mask, other=0.0)\n        w_val = tl.load(w_ptr, mask=k_mask, other=0.0)\n        acc += tl.dot(x_val, w_val, allow_tf32=True)\n\n        x_ptr += BLOCK_K * stride_xk\n        w_ptr += BLOCK_K * stride_wk\n\n    if bias_ptr is not None:\n        bias_ptrs = bias_ptr + offs_n\n        bias_val = tl.load(bias_ptrs, mask=offs_n < N, other=0.0)\n        acc += bias_val[None, :]\n\n    mask = (offs_m[:, None] < M) & (offs_n[None, :] < N)\n    out_ptrs = out_ptr + offs_m[:, None] * stride_out_m + offs_n[None, :] * stride_out_n\n    tl.store(out_ptrs, acc, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_features, out_features, max_dim):\n        super(ModelNew, self).__init__()\n        self.in_features = in_features\n        self.out_features = out_features\n        self.max_dim = max_dim\n        self.weight = nn.Parameter(torch.empty(out_features, in_features))\n        self.bias = nn.Parameter(torch.empty(out_features))\n        self.reset_parameters()\n\n    def reset_parameters(self):\n        nn.init.kaiming_uniform_(self.weight, a=math.sqrt(5))\n        fan_in, _ = nn.init._calculate_fan_in_and_fan_out(self.weight)\n        bound = 1 / math.sqrt(fan_in) if fan_in > 0 else 0\n        nn.init.uniform_(self.bias, -bound, bound)\n\n    def forward(self, x):\n        M, K = x.shape\n        N = self.out_features\n        out = torch.empty((M, N), device=x.device, dtype=x.dtype)\n\n        grid = lambda META: (triton.cdiv(M, META['BLOCK_M']) * triton.cdiv(N, META['BLOCK_N']), )\n        _gemm_kernel[grid](\n            x, self.weight, self.bias, out,\n            M, N, K,\n            x.stride(0), x.stride(1),\n            self.weight.stride(0), self.weight.stride(1),\n            out.stride(0), out.stride(1),\n            BLOCK_M=64, BLOCK_N=64, BLOCK_K=32\n        )\n\n        x = out\n        x = torch.max(x, dim=self.max_dim, keepdim=True).values\n        x = x - x.mean(dim=1, keepdim=True)\n        x = torch.nn.functional.gelu(x)\n        return x\n\nbatch_size = 128\nin_features = 512\nout_features = 1024\nmax_dim = 1\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_features)]\n\ndef get_init_inputs():\n    return [in_features, out_features, max_dim]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "7175c92a-759d-478f-9013-35e5c3c5c156", "generation": 1, "timestamp": 1754579440.7996612, "iteration_found": 1, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_80_Gemm_Max_Subtract_GELU", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "runtime_error": "Traceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 2045, in dot\n    return _semantic.dot(input, other, acc, input_precision, max_num_imprecise_acc, out_dtype)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 1498, in dot\n    assert lhs.shape[-1].value == rhs.shape[\nAssertionError: First input shape (['constexpr[64]', 'constexpr[32]']) and second input shape ['constexpr[64]', 'constexpr[32]'] are not compatible for matmul (second index of first shape (32) must be equal to first index of second shape (64)\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpb8wdo9dc.py\", line 73, in forward\n    _gemm_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 29:15:\n\n    x_ptr += offs_m[:, None] * stride_xm + offs_k[None, :] * stride_xk\n    w_ptr += offs_n[:, None] * stride_wn + offs_k[None, :] * stride_wk\n\n    acc = tl.zeros((BLOCK_M, BLOCK_N), dtype=tl.float32)\n\n    for k in range(0, K, BLOCK_K):\n        k_remaining = K - k\n        k_mask = offs_k[None, :] < k_remaining\n        x_val = tl.load(x_ptr, mask=k_mask, other=0.0)\n        w_val = tl.load(w_ptr, mask=k_mask, other=0.0)\n        acc += tl.dot(x_val, w_val, allow_tf32=True)\n               ^\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 2045, in dot\n    return _semantic.dot(input, other, acc, input_precision, max_num_imprecise_acc, out_dtype)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 1498, in dot\n    assert lhs.shape[-1].value == rhs.shape[\nAssertionError: First input shape (['constexpr[64]', 'constexpr[32]']) and second input shape ['constexpr[64]', 'constexpr[32]'] are not compatible for matmul (second index of first shape (32) must be equal to first index of second shape (64)\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.0827, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.0631, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:0", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0827, "speed_up": 1.311, "custom_timing": 0.0631}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}