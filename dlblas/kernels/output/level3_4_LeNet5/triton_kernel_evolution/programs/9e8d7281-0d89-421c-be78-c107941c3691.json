{"id": "9e8d7281-0d89-421c-be78-c107941c3691", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef linear_kernel(\n    x_ptr, weight_ptr, bias_ptr, output_ptr,\n    m, n, k,\n    stride_xm, stride_xk,\n    stride_wn, stride_wk,\n    stride_om, stride_on,\n    BLOCK_K: tl.constexpr,\n):\n    pid_m = tl.program_id(0)\n    pid_n = tl.program_id(1)\n    \n    # Boundary check for program IDs\n    if pid_m >= m or pid_n >= n:\n        return\n    \n    x_row_ptr = x_ptr + pid_m * stride_xm\n    weight_col_ptr = weight_ptr + pid_n * stride_wn\n    \n    # Initialize accumulator as scalar\n    acc = 0.0\n    # Process in larger chunks with vectorization\n    for block_idx in range(0, k, BLOCK_K):\n        k_offs = block_idx + tl.arange(0, BLOCK_K)\n        mask_k = k_offs < k\n        \n        # Vectorized load for input and weight\n        x_val = tl.load(x_row_ptr + k_offs, mask=mask_k, other=0.0)\n        weight_val = tl.load(weight_col_ptr + k_offs, mask=mask_k, other=0.0)\n        \n        # Optimized accumulation with vector operations\n        acc += tl.sum(x_val * weight_val)\n    \n    # Add bias\n    if bias_ptr is not None:\n        bias_val = tl.load(bias_ptr + pid_n)\n        acc += bias_val\n    \n    # Compute output pointer location\n    output_ptr_loc = output_ptr + pid_m * stride_om + pid_n * stride_on\n    tl.store(output_ptr_loc, acc)\n\ndef triton_linear(x, weight, bias):\n    m, k = x.shape\n    n, k2 = weight.shape\n    assert k == k2, \"Incompatible dimensions\"\n    \n    output = torch.empty((m, n), device=x.device, dtype=x.dtype)\n    \n    # Optimized block size for H100 architecture\n    BLOCK_K = 256  # Increased block size for better memory efficiency\n    grid = (m, n)\n    \n    linear_kernel[grid](\n        x, weight, bias, output,\n        m, n, k,\n        x.stride(0), x.stride(1),\n        weight.stride(0), weight.stride(1),\n        output.stride(0), output.stride(1),\n        BLOCK_K=BLOCK_K\n    )\n    \n    return output\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_classes):\n        super(ModelNew, self).__init__()\n        self.conv1 = nn.Conv2d(in_channels=1, out_channels=6, kernel_size=5, stride=1)\n        self.conv2 = nn.Conv2d(in_channels=6, out_channels=16, kernel_size=5, stride=1)\n        self.fc1 = nn.Linear(in_features=16*5*5, out_features=120)\n        self.fc2 = nn.Linear(in_features=120, out_features=84)\n        self.fc3 = nn.Linear(in_features=84, out_features=num_classes)\n    \n    def forward(self, x):\n        x = F.relu(self.conv1(x))\n        x = F.max_pool2d(x, kernel_size=2, stride=2)\n        x = F.relu(self.conv2(x))\n        x = F.max_pool2d(x, kernel_size=2, stride=2)\n        x = x.view(-1, 16*5*5)\n        \n        # Use Triton implementation for fc1\n        x = F.relu(triton_linear(x, self.fc1.weight, self.fc1.bias))\n        \n        x = F.relu(self.fc2(x))\n        x = self.fc3(x)\n        return x\n\n# Test code for the LeNet-5 model\nbatch_size = 1\nnum_classes = 10\n\ndef get_inputs():\n    return [torch.randn(batch_size, 1, 32, 32)]\n\ndef get_init_inputs():\n    return [num_classes]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "473dbd1c-d41e-4500-8801-e68c7daab6d3", "generation": 3, "timestamp": 1754598926.636252, "iteration_found": 29, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.877, "runtime_ms": 0.235, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:1", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.206, "speed_up": 0.877, "custom_timing": 0.235}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.907, "runtime_ms": 0.227, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:4", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.206, "speed_up": 0.907, "custom_timing": 0.227}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}