{"id": "47ad655e-044f-4341-9b16-9c6093de9c38", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\nimport math\n\n@triton.jit\ndef gru_cell_kernel(\n    x_ptr, h_prev_ptr, w_ih_ptr, w_hh_ptr, \n    output_ptr, input_size, hidden_size, \n    stride_xb, stride_hb, stride_oh,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    batch_idx = pid // hidden_size\n    hidden_idx = pid % hidden_size\n\n    if batch_idx >= input_size:  # Input size used as batch size proxy\n        return\n\n    # Gate indices\n    r_idx = hidden_idx\n    z_idx = hidden_idx + hidden_size\n    n_idx = hidden_idx + 2 * hidden_size\n\n    # Reset gate computation\n    r_val = 0.0\n    for block in range(0, input_size, BLOCK_SIZE):\n        offs = block + tl.arange(0, BLOCK_SIZE)\n        mask = offs < input_size\n        x_val = tl.load(x_ptr + batch_idx * stride_xb + offs, mask=mask, other=0.0)\n        w_ih_r = tl.load(w_ih_ptr + r_idx * input_size + offs, mask=mask, other=0.0)\n        r_val += tl.sum(x_val * w_ih_r)\n    \n    for block in range(0, hidden_size, BLOCK_SIZE):\n        offs = block + tl.arange(0, BLOCK_SIZE)\n        mask = offs < hidden_size\n        h_val = tl.load(h_prev_ptr + batch_idx * stride_hb + offs, mask=mask, other=0.0)\n        w_hh_r = tl.load(w_hh_ptr + r_idx * hidden_size + offs, mask=mask, other=0.0)\n        r_val += tl.sum(h_val * w_hh_r)\n    \n    r_val = tl.sigmoid(r_val)\n\n    # Update gate computation\n    z_val = 0.0\n    for block in range(0, input_size, BLOCK_SIZE):\n        offs = block + tl.arange(0, BLOCK_SIZE)\n        mask = offs < input_size\n        x_val = tl.load(x_ptr + batch_idx * stride_xb + offs, mask=mask, other=0.0)\n        w_ih_z = tl.load(w_ih_ptr + z_idx * input_size + offs, mask=mask, other=0.0)\n        z_val += tl.sum(x_val * w_ih_z)\n    \n    for block in range(0, hidden_size, BLOCK_SIZE):\n        offs = block + tl.arange(0, BLOCK_SIZE)\n        mask = offs < hidden_size\n        h_val = tl.load(h_prev_ptr + batch_idx * stride_hb + offs, mask=mask, other=0.0)\n        w_hh_z = tl.load(w_hh_ptr + z_idx * hidden_size + offs, mask=mask, other=0.0)\n        z_val += tl.sum(h_val * w_hh_z)\n    \n    z_val = tl.sigmoid(z_val)\n\n    # New gate computation\n    n_val = 0.0\n    for block in range(0, input_size, BLOCK_SIZE):\n        offs = block + tl.arange(0, BLOCK_SIZE)\n        mask = offs < input_size\n        x_val = tl.load(x_ptr + batch_idx * stride_xb + offs, mask=mask, other=0.0)\n        w_ih_n = tl.load(w_ih_ptr + n_idx * input_size + offs, mask=mask, other=0.0)\n        n_val += tl.sum(x_val * w_ih_n)\n    \n    for block in range(0, hidden_size, BLOCK_SIZE):\n        offs = block + tl.arange(0, BLOCK_SIZE)\n        mask = offs < hidden_size\n        h_val = tl.load(h_prev_ptr + batch_idx * stride_hb + offs, mask=mask, other=0.0)\n        w_hh_n = tl.load(w_hh_ptr + n_idx * hidden_size + offs, mask=mask, other=0.0)\n        n_val += r_val * tl.sum(h_val * w_hh_n)\n    \n    n_val = tl.tanh(n_val)\n\n    # Hidden state update\n    h_prev_val = tl.load(h_prev_ptr + batch_idx * stride_hb + hidden_idx)\n    h_new_val = (1 - z_val) * n_val + z_val * h_prev_val\n    tl.store(output_ptr + batch_idx * stride_oh + hidden_idx, h_new_val)\n\nclass GRULayer(nn.Module):\n    def __init__(self, input_size, hidden_size, bias=True):\n        super(GRULayer, self).__init__()\n        self.input_size = input_size\n        self.hidden_size = hidden_size\n        \n        # Weight parameters\n        self.weight_ih = nn.Parameter(torch.empty(3 * hidden_size, input_size))\n        self.weight_hh = nn.Parameter(torch.empty(3 * hidden_size, hidden_size))\n        \n        # Bias parameters\n        if bias:\n            self.bias_ih = nn.Parameter(torch.empty(3 * hidden_size))\n            self.bias_hh = nn.Parameter(torch.empty(3 * hidden_size))\n        else:\n            self.register_parameter('bias_ih', None)\n            self.register_parameter('bias_hh', None)\n        \n        self.reset_parameters()\n\n    def reset_parameters(self):\n        nn.init.xavier_uniform_(self.weight_ih)\n        nn.init.orthogonal_(self.weight_hh)\n        if self.bias_ih is not None:\n            nn.init.zeros_(self.bias_ih)\n            nn.init.zeros_(self.bias_hh)\n\n    def forward(self, x, h_prev):\n        batch_size = x.size(0)\n        h_new = torch.empty_like(h_prev)\n        \n        # Launch kernel\n        grid = (batch_size * self.hidden_size,)\n        BLOCK_SIZE = 128\n        \n        gru_cell_kernel[grid](\n            x, h_prev, self.weight_ih, self.weight_hh, \n            h_new, self.input_size, self.hidden_size,\n            x.stride(0), h_prev.stride(0), h_new.stride(0),\n            BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        return h_new\n\nclass ModelNew(nn.Module):\n    def __init__(self, input_size, hidden_size, num_layers=3, bias=True, batch_first=False):\n        super(ModelNew, self).__init__()\n        self.input_size = input_size\n        self.hidden_size = hidden_size\n        self.num_layers = num_layers\n        self.bias = bias\n        self.batch_first = batch_first\n        \n        # Create separate layers for forward and backward passes\n        self.forward_layers = nn.ModuleList()\n        self.backward_layers = nn.ModuleList()\n        for i in range(num_layers):\n            layer_input_size = input_size if i == 0 else 2 * hidden_size\n            self.forward_layers.append(GRULayer(layer_input_size, hidden_size, bias))\n            self.backward_layers.append(GRULayer(layer_input_size, hidden_size, bias))\n\n    def forward(self, x):\n        if self.batch_first:\n            x = x.transpose(0, 1)\n            \n        seq_len, batch_size, _ = x.size()\n        device = x.device\n        \n        # Initialize outputs\n        output = torch.zeros(seq_len, batch_size, 2 * self.hidden_size, device=device)\n        \n        # Process each layer\n        for layer_idx in range(self.num_layers):\n            # Initialize hidden states\n            h_forward = torch.zeros(batch_size, self.hidden_size, device=device)\n            h_backward = torch.zeros(batch_size, self.hidden_size, device=device)\n            \n            # Temporary outputs for current layer\n            layer_output_forward = []\n            layer_output_backward = []\n            \n            # Get input for this layer\n            current_input = x if layer_idx == 0 else output\n            \n            # Forward direction\n            for t in range(seq_len):\n                h_forward = self.forward_layers[layer_idx](current_input[t], h_forward)\n                layer_output_forward.append(h_forward)\n            \n            # Backward direction\n            for t in range(seq_len-1, -1, -1):\n                h_backward = self.backward_layers[layer_idx](current_input[t], h_backward)\n                layer_output_backward.insert(0, h_backward)  # Maintain time order\n            \n            # Combine directions\n            output_forward = torch.stack(layer_output_forward)\n            output_backward = torch.stack(layer_output_backward)\n            output = torch.cat([output_forward, output_backward], dim=-1)\n        \n        if self.batch_first:\n            output = output.transpose(0, 1)\n            \n        return output\n\n# Test code\nbatch_size = 10\nseq_len = 512\ninput_size = 128\nhidden_size = 256\nnum_layers = 6\n\ndef get_inputs():\n    return [torch.randn(seq_len, batch_size, input_size)]\n\ndef get_init_inputs():\n    return [input_size, hidden_size, num_layers]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "39525e76-a701-4d5c-8df1-061d1e5c099b", "generation": 2, "timestamp": 1754595563.6923757, "iteration_found": 17, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_41_GRUBirectional", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpnjljm149.py\", line 172, in forward\n    h_forward = self.forward_layers[layer_idx](current_input[t], h_forward)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpnjljm149.py\", line 121, in forward\n    gru_cell_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 281, in compile\n    key = f\"{triton_key()}-{src.hash()}-{backend.hash()}-{options.hash()}-{str(sorted(env_vars.items()))}\"\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 78, in hash\n    key = f\"{self.fn.cache_key}-{str(self.attrs)}-{sorted_sig}-{constants_key}\"\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 696, in cache_key\n    dependencies_finder.visit(self.parse())\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 426, in generic_visit\n    self.visit(item)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 163, in visit_FunctionDef\n    self.generic_visit(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 426, in generic_visit\n    self.visit(item)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 217, in visit_Assign\n    self.generic_visit(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 428, in generic_visit\n    self.visit(value)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 428, in generic_visit\n    self.visit(value)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/ast.py\", line 418, in visit\n    return visitor(node)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 156, in visit_Attribute\n    ret = getattr(lhs, node.attr)\nAttributeError: module 'triton.language' has no attribute 'tanh'\n", "runtime_error_name": "builtins.AttributeError", "reference_timing_ms": 68.4, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": false, "correctness": false, "score": -100.0, "stage": "no_valid_triton_code", "feedback": "You need to generate real and valid triton code for the core function. The key word 'import triton' is not found."}, "island": 1}, "artifacts_json": null, "artifact_dir": null}