{"id": "22319b6d-aa78-4a65-bcf7-87d0984b3f0f", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _reduce_partial_sums(\n    x_ptr,\n    sum_ptr,\n    sum_sq_ptr,\n    num_el,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid_channel = tl.program_id(0)\n    pid_chunk = tl.program_id(1)\n    base_ptr = x_ptr + pid_channel * num_el\n    sum_acc = tl.zeros((1,), dtype=tl.float32)\n    sum_sq_acc = tl.zeros((1,), dtype=tl.float32)\n    \n    for i in range(0, BLOCK_SIZE, 4):\n        offsets = pid_chunk * BLOCK_SIZE + i + tl.arange(0, 4)\n        mask = offsets < (pid_chunk + 1) * BLOCK_SIZE\n        mask = mask & (offsets < num_el)\n        x_vec = tl.load(base_ptr + offsets, mask=mask, other=0.0)\n        sum_acc += tl.sum(x_vec)\n        sum_sq_acc += tl.sum(x_vec * x_vec)\n    \n    tl.atomic_add(sum_ptr + pid_channel, sum_acc)\n    tl.atomic_add(sum_sq_ptr + pid_channel, sum_sq_acc)\n\n@triton.jit\ndef _batch_norm_forward(\n    x_ptr,\n    y_ptr,\n    mean_ptr,\n    var_ptr,\n    weight_ptr,\n    bias_ptr,\n    eps,\n    num_el,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid_channel = tl.program_id(0)\n    pid_chunk = tl.program_id(1)\n    base_ptr_x = x_ptr + pid_channel * num_el\n    base_ptr_y = y_ptr + pid_channel * num_el\n    mean_val = tl.load(mean_ptr + pid_channel)\n    var_val = tl.load(var_ptr + pid_channel)\n    weight = tl.load(weight_ptr + pid_channel)\n    bias = tl.load(bias_ptr + pid_channel)\n    inv_std = 1.0 / tl.sqrt(var_val + eps)\n    scale = weight * inv_std\n    \n    for i in range(0, BLOCK_SIZE, 4):\n        offsets = pid_chunk * BLOCK_SIZE + i + tl.arange(0, 4)\n        mask = offsets < (pid_chunk + 1) * BLOCK_SIZE\n        mask = mask & (offsets < num_el)\n        x_vec = tl.load(base_ptr_x + offsets, mask=mask, other=0.0)\n        centered = x_vec - mean_val\n        scaled = centered * scale\n        y_vec = scaled + bias\n        tl.store(base_ptr_y + offsets, y_vec, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_features: int):\n        super().__init__()\n        self.num_features = num_features\n        self.weight = nn.Parameter(torch.ones(num_features))\n        self.bias = nn.Parameter(torch.zeros(num_features))\n        self.eps = 1e-5\n        \n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        x = x.contiguous()\n        N, C, H, W = x.shape\n        num_el = N * H * W\n        BLOCK_SIZE = 4096\n        \n        # Reduce per-channel statistics\n        sum_buf = torch.zeros(C, device=x.device, dtype=torch.float32)\n        sum_sq_buf = torch.zeros(C, device=x.device, dtype=torch.float32)\n        grid_reduce = (C, triton.cdiv(num_el, BLOCK_SIZE))\n        _reduce_partial_sums[grid_reduce](\n            x, sum_buf, sum_sq_buf, num_el, BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        # Compute mean and variance\n        mean = sum_buf / num_el\n        variance = (sum_sq_buf / num_el) - mean * mean\n        \n        # Apply normalization\n        y = torch.empty_like(x)\n        grid_norm = (C, triton.cdiv(num_el, BLOCK_SIZE))\n        _batch_norm_forward[grid_norm](\n            x, y, mean, variance, \n            self.weight, self.bias, self.eps,\n            num_el, BLOCK_SIZE=BLOCK_SIZE\n        )\n        return y\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [features]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "6fd594b3-598d-4054-afd2-b585361ef1d0", "generation": 2, "timestamp": 1754637053.5279171, "iteration_found": 13, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level1_33_BatchNorm", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmprqa2y1x_.py\", line 83, in forward\n    _reduce_partial_sums[grid_reduce](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 359, in compile\n    next_module = compile_ir(module, metadata)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/backends/nvidia/compiler.py\", line 455, in <lambda>\n    stages[\"ttir\"] = lambda src, metadata: self.make_ttir(src, metadata, options, capability)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/backends/nvidia/compiler.py\", line 226, in make_ttir\n    pm.run(mod)\nRuntimeError: PassManager::run failed\n", "runtime_error_name": "builtins.RuntimeError", "reference_timing_ms": 0.245, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.646, "runtime_ms": 0.379, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:1", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.245, "speed_up": 0.646, "custom_timing": 0.379}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}