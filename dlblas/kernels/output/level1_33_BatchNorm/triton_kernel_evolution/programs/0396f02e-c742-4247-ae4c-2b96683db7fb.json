{"id": "0396f02e-c742-4247-ae4c-2b96683db7fb", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.autotune(\n    configs=[\n        triton.Config({'BLOCK_SIZE': 1024}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 2048}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 4096}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 8192}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 1024}, num_warps=8),\n        triton.Config({'BLOCK_SIZE': 2048}, num_warps=8),\n        triton.Config({'BLOCK_SIZE': 4096}, num_warps=8),\n    ],\n    key=['N', 'C', 'H', 'W'],\n)\n@triton.jit\ndef batch_norm_inference_kernel(\n    x_ptr,\n    output_ptr,\n    gamma_ptr,\n    beta_ptr,\n    mean_ptr,\n    var_ptr,\n    eps,\n    stride_n, stride_c, stride_h, stride_w,\n    N, C, H, W,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid_channel = tl.program_id(0)\n    pid_chunk = tl.program_id(1)\n    num_el = N * H * W\n    \n    start_idx = pid_chunk * BLOCK_SIZE\n    offsets = start_idx + tl.arange(0, BLOCK_SIZE)\n    mask = offsets < num_el\n\n    base_ptr_x = x_ptr + pid_channel * num_el\n    base_ptr_y = output_ptr + pid_channel * num_el\n\n    x = tl.load(base_ptr_x + offsets, mask=mask, other=0.0)\n    \n    mean_val = tl.load(mean_ptr + pid_channel)\n    var_val = tl.load(var_ptr + pid_channel)\n    gamma = tl.load(gamma_ptr + pid_channel)\n    beta = tl.load(beta_ptr + pid_channel)\n    \n    inv_std = tl.math.rsqrt(var_val + eps)\n    normalized = (x - mean_val) * inv_std\n    out = normalized * gamma + beta\n    \n    tl.store(base_ptr_y + offsets, out, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_features: int):\n        super(ModelNew, self).__init__()\n        self.num_features = num_features\n        self.weight = nn.Parameter(torch.ones(num_features))\n        self.bias = nn.Parameter(torch.zeros(num_features))\n        self.register_buffer('running_mean', torch.zeros(num_features))\n        self.register_buffer('running_var', torch.ones(num_features))\n        self.eps = 1e-5\n        self.momentum = 0.1\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        if self.training:\n            return torch.nn.functional.batch_norm(\n                x, self.running_mean, self.running_var, \n                self.weight, self.bias, training=True,\n                momentum=self.momentum, eps=self.eps\n            )\n        else:\n            x = x.contiguous()\n            N, C, H, W = x.shape\n            output = torch.empty_like(x)\n            num_el = N * H * W\n            \n            grid = (C, triton.cdiv(num_el, 2048))\n            \n            batch_norm_inference_kernel[grid](\n                x, output, \n                self.weight, self.bias,\n                self.running_mean, self.running_var, self.eps,\n                x.stride(0), x.stride(1), x.stride(2), x.stride(3),\n                N, C, H, W\n            )\n            return output\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [features]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "37af2aed-3c89-46dd-b6eb-17a17db3f056", "generation": 2, "timestamp": 1754639994.2602558, "iteration_found": 28, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.431, "runtime_ms": 0.568, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.245, "speed_up": 0.431, "custom_timing": 0.568}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.431, "runtime_ms": 0.569, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:1", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.245, "speed_up": 0.431, "custom_timing": 0.569}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}