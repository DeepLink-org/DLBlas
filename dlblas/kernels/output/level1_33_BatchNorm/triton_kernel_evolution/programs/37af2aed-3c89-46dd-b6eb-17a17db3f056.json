{"id": "37af2aed-3c89-46dd-b6eb-17a17db3f056", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef batch_norm_inference_kernel(\n    x_ptr,\n    output_ptr,\n    gamma_ptr,\n    beta_ptr,\n    mean_ptr,\n    var_ptr,\n    eps,\n    stride_n, stride_c, stride_h, stride_w,\n    N, C, H, W,\n    BLOCK_SIZE: tl.constexpr\n):\n    # Parallelize over channels and spatial rows\n    pid_c = tl.program_id(0)\n    pid_row = tl.program_id(1)\n    \n    n = pid_row // H\n    h = pid_row % H\n    row_idx = tl.arange(0, BLOCK_SIZE)\n    mask = row_idx < W\n\n    # Compute pointer offsets for coalesced access\n    x_offset = n * stride_n + pid_c * stride_c + h * stride_h\n    ptr = x_ptr + x_offset + row_idx * stride_w\n    data = tl.load(ptr, mask=mask, other=0.0)\n\n    # Load statistics and parameters\n    mean_val = tl.load(mean_ptr + pid_c)\n    var_val = tl.load(var_ptr + pid_c)\n    gamma = tl.load(gamma_ptr + pid_c)\n    beta = tl.load(beta_ptr + pid_c)\n    \n    # Compute normalization with optimized math ops\n    inv_std = tl.math.rsqrt(var_val + eps)\n    normalized = (data - mean_val) * inv_std\n    out = normalized * gamma + beta\n    \n    # Store results with coalesced access\n    tl.store(output_ptr + x_offset + row_idx * stride_w, out, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, num_features: int):\n        super(ModelNew, self).__init__()\n        self.num_features = num_features\n        self.weight = nn.Parameter(torch.ones(num_features))\n        self.bias = nn.Parameter(torch.zeros(num_features))\n        self.register_buffer('running_mean', torch.zeros(num_features))\n        self.register_buffer('running_var', torch.ones(num_features))\n        self.eps = 1e-5\n        self.momentum = 0.1\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        if self.training:\n            # Use PyTorch for training to update statistics\n            return torch.nn.functional.batch_norm(\n                x, self.running_mean, self.running_var, \n                self.weight, self.bias, training=True,\n                momentum=self.momentum, eps=self.eps\n            )\n        else:\n            # Use optimized Triton kernel for inference\n            x = x.contiguous()\n            N, C, H, W = x.shape\n            output = torch.empty_like(x)\n            \n            # Configure grid and block for optimal parallelism\n            grid = (C, N * H)\n            BLOCK_SIZE = triton.next_power_of_2(W)\n            \n            batch_norm_inference_kernel[grid](\n                x, output, \n                self.weight, self.bias,\n                self.running_mean, self.running_var, self.eps,\n                x.stride(0), x.stride(1), x.stride(2), x.stride(3),\n                N, C, H, W, BLOCK_SIZE,\n                num_warps=8\n            )\n            return output\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [features]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "dd106020-6224-452b-bafd-180f842d9354", "generation": 1, "timestamp": 1754635941.1835175, "iteration_found": 8, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.431, "runtime_ms": 0.569, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:1", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.245, "speed_up": 0.431, "custom_timing": 0.569}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 0.581, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:6", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.245, "speed_up": 0.422, "custom_timing": 0.581}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}