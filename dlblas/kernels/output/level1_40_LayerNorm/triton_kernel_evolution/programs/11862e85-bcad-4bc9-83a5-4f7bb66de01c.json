{"id": "11862e85-bcad-4bc9-83a5-4f7bb66de01c", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _layer_norm_fused_kernel(\n    x_ptr,\n    y_ptr,\n    w_ptr,\n    b_ptr,\n    stride_xb,\n    stride_xh,\n    n_cols,\n    eps,\n    BLOCK_SIZE: tl.constexpr,\n):\n    row_idx = tl.program_id(0)\n    x_row_ptr = x_ptr + row_idx * stride_xb\n    y_row_ptr = y_ptr + row_idx * stride_xb\n    \n    # Compute mean\n    row_sum = tl.zeros([BLOCK_SIZE], dtype=tl.float32)\n    for block_start in range(0, n_cols, BLOCK_SIZE):\n        offsets = block_start + tl.arange(0, BLOCK_SIZE)\n        mask = offsets < n_cols\n        x_chunk = tl.load(x_row_ptr + offsets * stride_xh, mask=mask, other=0.0)\n        row_sum += x_chunk\n    mean = tl.sum(row_sum) / n_cols\n    \n    # Compute variance\n    row_sum_sq = tl.zeros([BLOCK_SIZE], dtype=tl.float32)\n    for block_start in range(0, n_cols, BLOCK_SIZE):\n        offsets = block_start + tl.arange(0, BLOCK_SIZE)\n        mask = offsets < n_cols\n        x_chunk = tl.load(x_row_ptr + offsets * stride_xh, mask=mask, other=0.0)\n        x_centered = tl.where(mask, x_chunk - mean, 0.0)\n        row_sum_sq += x_centered * x_centered\n    var = tl.sum(row_sum_sq) / n_cols\n    rstd = tl.math.rsqrt(var + eps)\n    \n    # Normalize and store\n    for block_start in range(0, n_cols, BLOCK_SIZE):\n        offsets = block_start + tl.arange(0, BLOCK_SIZE)\n        mask = offsets < n_cols\n        x_chunk = tl.load(x_row_ptr + offsets * stride_xh, mask=mask, other=0.0)\n        w = tl.load(w_ptr + offsets, mask=mask)\n        b = tl.load(b_ptr + offsets, mask=mask)\n        \n        x_norm = (x_chunk - mean) * rstd\n        y_chunk = x_norm * w + b\n        tl.store(y_row_ptr + offsets * stride_xh, y_chunk, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, normalized_shape: tuple):\n        super().__init__()\n        self.normalized_shape = normalized_shape\n        self.weight = nn.Parameter(torch.ones(*normalized_shape))\n        self.bias = nn.Parameter(torch.zeros(*normalized_shape))\n        self.eps = 1e-5\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        input_shape = x.shape\n        normalized_ndim = len(self.normalized_shape)\n        batch_dims = input_shape[:-normalized_ndim]\n        batch_size = math.prod(batch_dims)\n        N = math.prod(self.normalized_shape)\n        \n        x_flat = x.reshape(batch_size, N).contiguous()\n        output_flat = torch.empty_like(x_flat)\n        \n        BLOCK_SIZE = 1024\n        grid = (batch_size,)\n        _layer_norm_fused_kernel[grid](\n            x_flat,\n            output_flat,\n            self.weight.reshape(-1),\n            self.bias.reshape(-1),\n            x_flat.stride(0),\n            x_flat.stride(1),\n            N,\n            self.eps,\n            BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        return output_flat.reshape(input_shape)\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [(features, dim1, dim2)]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "76ad704a-c848-43cb-b99f-731e0a5c819b", "generation": 4, "timestamp": 1754644007.670143, "iteration_found": 19, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.005, "runtime_ms": 6.47, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0314, "speed_up": 0.005, "custom_timing": 6.47}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.092, "runtime_ms": 0.342, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0314, "speed_up": 0.092, "custom_timing": 0.342}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}