{"id": "a0405c43-22b3-45d2-b32c-1138acaf1572", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _layer_norm_fwd(\n    x_ptr,\n    y_ptr,\n    w_ptr,\n    b_ptr,\n    mean_ptr,\n    rstd_ptr,\n    stride_xb,\n    stride_xh,\n    n_cols,\n    eps,\n    BLOCK_SIZE: tl.constexpr\n):\n    row_idx = tl.program_id(0)\n    cols_offsets = tl.arange(0, BLOCK_SIZE)\n    mask = cols_offsets < n_cols\n    \n    x_ptrs = x_ptr + row_idx * stride_xb + cols_offsets * stride_xh\n    w_ptrs = w_ptr + cols_offsets\n    b_ptrs = b_ptr + cols_offsets\n    \n    x = tl.load(x_ptrs, mask=mask, other=0.0).to(tl.float32)\n    weight = tl.load(w_ptrs, mask=mask, other=0.0).to(tl.float32)\n    bias = tl.load(b_ptrs, mask=mask, other=0.0).to(tl.float32)\n    \n    mean = tl.sum(x, axis=0) / n_cols\n    x_centered = tl.where(mask, x - mean, 0.0)\n    var = tl.sum(x_centered * x_centered, axis=0) / n_cols\n    rstd = tl.math.rsqrt(var + eps)\n    \n    y = (x_centered * rstd) * weight + bias\n    \n    tl.store(y_ptr + row_idx * stride_xb + cols_offsets * stride_xh, y, mask=mask)\n    tl.store(mean_ptr + row_idx, mean)\n    tl.store(rstd_ptr + row_idx, rstd)\n\nclass ModelNew(nn.Module):\n    def __init__(self, normalized_shape: tuple):\n        super(ModelNew, self).__init__()\n        self.normalized_shape = normalized_shape\n        self.weight = nn.Parameter(torch.ones(*normalized_shape))\n        self.bias = nn.Parameter(torch.zeros(*normalized_shape))\n        self.eps = 1e-5\n\n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        original_shape = x.shape\n        flattened_size = math.prod(original_shape[1:])\n        x_flat = x.reshape(-1, flattened_size).contiguous()\n        \n        mean = torch.empty(x_flat.shape[0], device=x.device, dtype=torch.float32)\n        rstd = torch.empty(x_flat.shape[0], device=x.device, dtype=torch.float32)\n        y_flat = torch.empty_like(x_flat)\n        \n        weight_flat = self.weight.reshape(-1)\n        bias_flat = self.bias.reshape(-1)\n        \n        n_rows, n_cols = x_flat.shape\n        BLOCK_SIZE = triton.next_power_of_2(n_cols)\n        BLOCK_SIZE = min(BLOCK_SIZE, 4096)\n        \n        grid = (n_rows,)\n        _layer_norm_fwd[grid](\n            x_flat,\n            y_flat,\n            weight_flat,\n            bias_flat,\n            mean,\n            rstd,\n            x_flat.stride(0),\n            x_flat.stride(1),\n            n_cols,\n            self.eps,\n            BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        return y_flat.reshape(original_shape)\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [(features, dim1, dim2)]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "7027bfde-7af2-45c1-975a-03414eb544a9", "generation": 1, "timestamp": 1754640182.4881806, "iteration_found": 0, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level1_40_LayerNorm", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "max_difference": ["139.388168", "138.104950", "122.090027", "140.922531", "138.992188"], "avg_difference": ["0.821162", "1.151381", "1.151230", "1.151245", "1.151215"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 0.0314, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 8.24, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:2", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0314, "speed_up": 0.004, "custom_timing": 8.24}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}