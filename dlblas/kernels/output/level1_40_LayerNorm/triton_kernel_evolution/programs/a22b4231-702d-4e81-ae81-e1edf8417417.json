{"id": "a22b4231-702d-4e81-ae81-e1edf8417417", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport math\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _layer_norm_reduce_kernel(\n    x_ptr,\n    sum_ptr,\n    sum_sq_ptr,\n    N: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid_batch = tl.program_id(0)\n    pid_block = tl.program_id(1)\n    \n    block_start = pid_block * BLOCK_SIZE\n    offsets = block_start + tl.arange(0, BLOCK_SIZE)\n    mask = offsets < N\n    \n    x_ptrs = x_ptr + pid_batch * N + offsets\n    x = tl.load(x_ptrs, mask=mask, other=0.0)\n    \n    block_sum = tl.sum(x, axis=0)\n    block_sum_sq = tl.sum(x * x, axis=0)\n    \n    tl.atomic_add(sum_ptr + pid_batch, block_sum)\n    tl.atomic_add(sum_sq_ptr + pid_batch, block_sum_sq)\n\n@triton.jit\ndef _layer_norm_forward_kernel(\n    x_ptr,\n    weight_ptr,\n    bias_ptr,\n    mean_ptr,\n    var_ptr,\n    output_ptr,\n    eps,\n    N: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid_batch = tl.program_id(0)\n    pid_block = tl.program_id(1)\n    \n    block_start = pid_block * BLOCK_SIZE\n    offsets = block_start + tl.arange(0, BLOCK_SIZE)\n    mask = offsets < N\n    \n    x_ptrs = x_ptr + pid_batch * N + offsets\n    x = tl.load(x_ptrs, mask=mask, other=0.0)\n    \n    mean = tl.load(mean_ptr + pid_batch)\n    var_val = tl.load(var_ptr + pid_batch)\n    std = tl.sqrt(var_val + eps)\n    \n    x_normalized = (x - mean) / std\n    \n    w_ptrs = weight_ptr + offsets\n    b_ptrs = bias_ptr + offsets\n    w = tl.load(w_ptrs, mask=mask, other=0.0)\n    b = tl.load(b_ptrs, mask=mask, other=0.0)\n    \n    out = x_normalized * w + b\n    out_ptrs = output_ptr + pid_batch * N + offsets\n    tl.store(out_ptrs, out, mask=mask)\n\nclass ModelNew(nn.Module):\n    def __init__(self, normalized_shape: tuple):\n        super(ModelNew, self).__init__()\n        self.normalized_shape = normalized_shape\n        self.eps = 1e-5\n        self.gamma = nn.Parameter(torch.ones(normalized_shape))\n        self.beta = nn.Parameter(torch.zeros(normalized_shape))\n        \n    def forward(self, x: torch.Tensor) -> torch.Tensor:\n        input_shape = x.shape\n        normalized_ndim = len(self.normalized_shape)\n        batch_dims = input_shape[:-normalized_ndim]\n        batch_size = math.prod(batch_dims)\n        N = math.prod(self.normalized_shape)\n        \n        x_flat = x.reshape(batch_size, N)\n        sums = torch.zeros(batch_size, device=x.device, dtype=torch.float32)\n        sum_sqs = torch.zeros(batch_size, device=x.device, dtype=torch.float32)\n        \n        BLOCK_SIZE = 4096\n        grid_reduce = (batch_size, triton.cdiv(N, BLOCK_SIZE))\n        _layer_norm_reduce_kernel[grid_reduce](\n            x_flat, sums, sum_sqs, N, BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        mean = sums / N\n        variance = (sum_sqs / N) - (mean * mean)\n        \n        output_flat = torch.empty_like(x_flat)\n        gamma_flat = self.gamma.expand_as(x).reshape(-1)\n        beta_flat = self.beta.expand_as(x).reshape(-1)\n        \n        grid_forward = (batch_size, triton.cdiv(N, BLOCK_SIZE))\n        _layer_norm_forward_kernel[grid_forward](\n            x_flat, gamma_flat, beta_flat, mean, variance, output_flat, \n            self.eps, N, BLOCK_SIZE=BLOCK_SIZE\n        )\n        \n        return output_flat.reshape(input_shape)\n\nbatch_size = 16\nfeatures = 64\ndim1 = 256\ndim2 = 256\n\ndef get_inputs():\n    x = torch.randn(batch_size, features, dim1, dim2)\n    return [x]\n\ndef get_init_inputs():\n    return [(features, dim1, dim2)]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "182c4176-5619-4e60-a56c-d084677c61fc", "generation": 2, "timestamp": 1754641328.5481758, "iteration_found": 8, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.045, "runtime_ms": 0.692, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:0", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0314, "speed_up": 0.045, "custom_timing": 0.692}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.004, "runtime_ms": 7.35, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0314, "speed_up": 0.004, "custom_timing": 7.35}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}