{"id": "aa8ad3f3-d7bc-4482-ae53-5798adbe00fa", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n# Optimized kernel for subtract + HardSwish\n@triton.autotune(\n    configs=[\n        triton.Config({'BLOCK_SIZE': 128}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 256}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 512}, num_warps=4),\n        triton.Config({'BLOCK_SIZE': 1024}, num_warps=8),\n    ],\n    key=['n_elements'],\n)\n@triton.jit\ndef subtract_hardswish_kernel(\n    input_ptr,\n    output_ptr,\n    subtract_value,\n    n_elements,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    start_idx = pid * BLOCK_SIZE\n    offsets = start_idx + tl.arange(0, BLOCK_SIZE)\n    mask = offsets < n_elements\n    \n    x = tl.load(input_ptr + offsets, mask=mask)\n    x = x - subtract_value\n    y = x * tl.minimum(tl.maximum(x + 3.0, 0.0), 6.0) * (1.0 / 6.0)\n    tl.store(output_ptr + offsets, y, mask=mask)\n\n# Optimized kernel for maxpool + Mish\n@triton.jit\ndef maxpool_mish_kernel(\n    input_ptr,\n    output_ptr,\n    stride_b, stride_c, stride_h, stride_w,\n    stride_b_out, stride_c_out, stride_h_out, stride_w_out,\n    input_h, input_w,\n    output_h, output_w,\n    BLOCK_SIZE: tl.constexpr\n):\n    pid = tl.program_id(0)\n    block_start = pid * BLOCK_SIZE\n    offsets = block_start + tl.arange(0, BLOCK_SIZE)\n    \n    if block_start >= output_h * output_w:\n        return\n        \n    out_y = offsets // output_w\n    out_x = offsets % output_w\n    \n    in_y = out_y * 2\n    in_x = out_x * 2\n    \n    batch_idx = tl.program_id(1)\n    channel_idx = tl.program_id(2)\n    \n    # Load 2x2 window\n    ptr00 = input_ptr + batch_idx*stride_b + channel_idx*stride_c + in_y*stride_h + in_x*stride_w\n    ptr01 = ptr00 + stride_w\n    ptr10 = ptr00 + stride_h\n    ptr11 = ptr01 + stride_h\n    \n    v00 = tl.load(ptr00)\n    v01 = tl.load(ptr01, mask=(in_x+1 < input_w))\n    v10 = tl.load(ptr10, mask=(in_y+1 < input_h))\n    v11 = tl.load(ptr11, mask=((in_x+1 < input_w) & (in_y+1 < input_h)))\n    \n    # Max pooling\n    max_val0 = tl.maximum(v00, v01)\n    max_val1 = tl.maximum(v10, v11)\n    max_val = tl.maximum(max_val0, max_val1)\n    \n    # Mish activation\n    sp = tl.where(max_val > 20.0, max_val, tl.log(1.0 + tl.exp(max_val)))\n    tanh_sp = 2 * tl.sigmoid(2 * sp) - 1\n    mish_val = max_val * tanh_sp\n    \n    # Store result\n    out_ptr = output_ptr + batch_idx*stride_b_out + channel_idx*stride_c_out + out_y*stride_h_out + out_x*stride_w_out\n    tl.store(out_ptr, mish_val)\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size, subtract_value, pool_kernel_size):\n        super(ModelNew, self).__init__()\n        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size, padding=kernel_size//2)\n        self.subtract_value = subtract_value\n        self.pool_kernel_size = pool_kernel_size\n        self.output_h = (32 - kernel_size + 1) // pool_kernel_size\n        self.output_w = (32 - kernel_size + 1) // pool_kernel_size\n\n    def forward(self, x):\n        x = self.conv(x)\n        \n        # Subtract + HardSwish fusion\n        output1 = torch.empty_like(x)\n        n_elements = x.numel()\n        grid1 = lambda meta: (triton.cdiv(n_elements, meta['BLOCK_SIZE']),)\n        subtract_hardswish_kernel[grid1](\n            x, output1, self.subtract_value, n_elements\n        )\n        \n        # MaxPool + Mish fusion\n        batch_size, out_channels, height, width = output1.shape\n        output2 = torch.empty((batch_size, out_channels, self.output_h, self.output_w), \n                             device=output1.device, dtype=output1.dtype)\n        \n        grid2 = (self.output_h * self.output_w, batch_size, out_channels)\n        maxpool_mish_kernel[grid2](\n            output1, output2,\n            output1.stride(0), output1.stride(1), output1.stride(2), output1.stride(3),\n            output2.stride(0), output2.stride(1), output2.stride(2), output2.stride(3),\n            height, width,\n            self.output_h, self.output_w,\n            BLOCK_SIZE=1\n        )\n        \n        return output2\n\nbatch_size = 128\nin_channels = 3\nout_channels = 16\nheight, width = 32, 32\nkernel_size = 3\nsubtract_value = 0.5\npool_kernel_size = 2\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_channels, height, width)]\n\ndef get_init_inputs():\n    return [in_channels, out_channels, kernel_size, subtract_value, pool_kernel_size]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "f4c7f690-f448-45fa-b79f-10a10ba0e8d8", "generation": 3, "timestamp": 1754568554.8994899, "iteration_found": 14, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_35_Conv2d_Subtract_HardSwish_MaxPool_Mish", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:3", "max_difference": ["2.180188", "2.409343", "2.155464", "2.162948", "2.268815"], "avg_difference": ["0.131824", "0.132167", "0.132596", "0.132329", "0.132022"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 0.0812, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_35_Conv2d_Subtract_HardSwish_MaxPool_Mish", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:2", "runtime_error": "Traceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1654, in arange\n    return _semantic.arange(start, end)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 574, in arange\n    raise ValueError(\"arange's arguments must be of type tl.constexpr\")\nValueError: arange's arguments must be of type tl.constexpr\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp0nz04wl7.py\", line 78, in forward\n    fused_ops_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 33:20:\n\n    offs_col = tl.arange(0, P2)\n    mask = offs_col < input_w\n    row0 = tl.load(row0_ptr + offs_col * stride_w, mask=mask, other=0.0)\n    row1 = tl.load(row1_ptr + offs_col * stride_w, mask=mask, other=0.0)\n\n    row0 = row0 - subtract_value\n    row0 = row0 * tl.minimum(tl.maximum(row0 + 3, 0), 6) / 6\n    row1 = row1 - subtract_value\n    row1 = row1 * tl.minimum(tl.maximum(row1 + 3, 0), 6) / 6\n\n    indices00 = 2 * tl.arange(0, output_w)\n                    ^\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1654, in arange\n    return _semantic.arange(start, end)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 574, in arange\n    raise ValueError(\"arange's arguments must be of type tl.constexpr\")\nValueError: arange's arguments must be of type tl.constexpr\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.0812, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "island": 1}, "artifacts_json": null, "artifact_dir": null}