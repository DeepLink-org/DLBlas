{"id": "ec339245-3b2b-4bca-8916-5c39db592b3e", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _fused_activations_kernel(\n    x_ptr,\n    add_ptr,\n    output_ptr,\n    n_rows,\n    n_cols,\n    BLOCK_SIZE_R: tl.constexpr,\n    BLOCK_SIZE_C: tl.constexpr,\n):\n    pid_row = tl.program_id(0)\n    pid_col = tl.program_id(1)\n    \n    row_start = pid_row * BLOCK_SIZE_R\n    col_start = pid_col * BLOCK_SIZE_C\n    \n    col_offsets = col_start + tl.arange(0, BLOCK_SIZE_C)\n    col_mask = col_offsets < n_cols\n    \n    # Preload add values for column block - use cache modifier\n    add_vals = tl.load(add_ptr + col_offsets, mask=col_mask, other=0.0, cache_modifier=\".cg\")\n    \n    for r in range(BLOCK_SIZE_R):\n        row_idx = row_start + r\n        if row_idx < n_rows:\n            # Vectorized load with cache hint\n            x_ptrs = x_ptr + row_idx * n_cols + col_offsets\n            x_vals = tl.load(x_ptrs, mask=col_mask, other=0.0, cache_modifier=\".cg\")\n            \n            # Fused operations with intermediate reuse\n            y = x_vals + add_vals\n            sig_y = tl.sigmoid(y)\n            swish = y * sig_y\n            sig_swish = tl.sigmoid(2.0 * swish)\n            tanh = 2.0 * sig_swish - 1.0\n            # Optimized GELU computation\n            z = tanh * 0.7071067811865475\n            erf_z = tl.erf(z)\n            gelu = 0.5 * tanh * (1.0 + erf_z)\n            hardtanh = tl.minimum(tl.maximum(gelu, -1.0), 1.0)\n            \n            # Vectorized store\n            out_ptrs = output_ptr + row_idx * n_cols + col_offsets\n            tl.store(out_ptrs, hardtanh, mask=col_mask)\n\ndef fused_activations(x, add_value):\n    output = torch.empty_like(x)\n    n_rows, n_cols = x.shape\n    \n    # Optimized block sizes for H100 architecture\n    BLOCK_SIZE_R = 4\n    BLOCK_SIZE_C = 64  # Improved cache line utilization\n    \n    grid = (triton.cdiv(n_rows, BLOCK_SIZE_R), triton.cdiv(n_cols, BLOCK_SIZE_C))\n    num_warps = 2  # Better occupancy with smaller block size\n    \n    _fused_activations_kernel[grid](\n        x, add_value, output, n_rows, n_cols,\n        BLOCK_SIZE_R=BLOCK_SIZE_R, \n        BLOCK_SIZE_C=BLOCK_SIZE_C,\n        num_warps=num_warps\n    )\n    return output\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_features, out_features, add_value_shape):\n        super(ModelNew, self).__init__()\n        self.matmul = nn.Linear(in_features, out_features)\n        self.add_value = nn.Parameter(torch.randn(add_value_shape)) \n\n    def forward(self, x):\n        x = self.matmul(x)\n        x = fused_activations(x, self.add_value)\n        return x\n\nbatch_size = 128\nin_features = 1024\nout_features = 512\nadd_value_shape = (out_features,)\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_features)]\n\ndef get_init_inputs():\n    return [in_features, out_features, add_value_shape]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "19ed5425-701b-4870-b997-b1b8328bf854", "generation": 2, "timestamp": 1754589130.1536138, "iteration_found": 22, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": true, "score": 39.10000000000001, "speed_up": 1.191, "runtime_ms": 0.0732, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:0", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0872, "speed_up": 1.191, "custom_timing": 0.0732}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": true, "score": 39.900000000000006, "speed_up": 1.199, "runtime_ms": 0.0727, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:2", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.0872, "speed_up": 1.199, "custom_timing": 0.0727}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}