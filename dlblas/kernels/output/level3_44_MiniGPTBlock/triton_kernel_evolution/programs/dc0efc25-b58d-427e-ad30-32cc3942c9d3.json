{"id": "dc0efc25-b58d-427e-ad30-32cc3942c9d3", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nimport math\nimport triton\nimport triton.language as tl\n\n# From https://github.com/karpathy/minGPT/blob/master/mingpt/model.py\n\nclass NewGELU(nn.Module):\n    \"\"\"\n    Implementation of the GELU activation function currently in Google BERT repo (identical to OpenAI GPT).\n    Reference: Gaussian Error Linear Units (GELU) paper: https://arxiv.org/abs/1606.08415\n    \"\"\"\n    def __init__(self):\n        super(NewGELU, self).__init__()\n    \n    def forward(self, x):\n        return 0.5 * x * (1.0 + torch.tanh(math.sqrt(2.0 / math.pi) * (x + 0.044715 * torch.pow(x, 3.0))))\n\n@triton.jit\ndef _attn_fwd(\n    Q, K, V, Out,\n    stride_qb, stride_qh, stride_qn, stride_qd,\n    stride_kb, stride_kh, stride_kn, stride_kd,\n    stride_vb, stride_vh, stride_vn, stride_vd,\n    stride_ob, stride_oh, stride_on, stride_od,\n    seq_len,\n    head_size,\n    BLOCK_M: tl.constexpr, BLOCK_N: tl.constexpr, BLOCK_DMODEL: tl.constexpr,\n    IS_CAUSAL: tl.constexpr\n):\n    pid_batch = tl.program_id(0)\n    pid_head = tl.program_id(1)\n    pid_m = tl.program_id(2)\n\n    start_m = pid_m * BLOCK_M\n    offs_m = start_m + tl.arange(0, BLOCK_M)\n    offs_n = tl.arange(0, BLOCK_N)\n    offs_d = tl.arange(0, BLOCK_DMODEL)\n    \n    # Head dimension mask\n    d_mask = offs_d < head_size\n    \n    # Pointers to Q, K, V\n    q_ptr = Q + pid_batch * stride_qb + pid_head * stride_qh + \\\n            (offs_m[:, None] * stride_qn + offs_d[None, :] * stride_qd)\n    k_ptr = K + pid_batch * stride_kb + pid_head * stride_kh + \\\n            (offs_n[:, None] * stride_kn + offs_d[None, :] * stride_kd)\n    v_ptr = V + pid_batch * stride_vb + pid_head * stride_vh + \\\n            (offs_n[:, None] * stride_vn + offs_d[None, :] * stride_vd)\n    \n    # Initialize accumulator\n    acc = tl.zeros([BLOCK_M, BLOCK_DMODEL], dtype=tl.float32)\n    m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float('inf')\n    l_i = tl.zeros([BLOCK_M], dtype=tl.float32)\n    \n    # Scale factor\n    scale = 1.0 / tl.sqrt(tl.float32(head_size))\n    \n    # Loop over blocks\n    lo = 0\n    hi = tl.minimum((start_m + BLOCK_M) if IS_CAUSAL else seq_len, seq_len)\n    for start_n in range(lo, hi, BLOCK_N):\n        start_n = tl.multiple_of(start_n, BLOCK_N)\n        \n        # Load K and V blocks with head dimension mask\n        k = tl.load(k_ptr + start_n * stride_kn, \n                   mask=((start_n + offs_n)[:, None] < seq_len) & d_mask[None, :], \n                   other=0.0)\n        v = tl.load(v_ptr + start_n * stride_vn, \n                   mask=((start_n + offs_n)[:, None] < seq_len) & d_mask[None, :], \n                   other=0.0)\n        \n        # Load Q block with head dimension mask\n        q = tl.load(q_ptr, \n                   mask=(offs_m[:, None] < seq_len) & d_mask[None, :], \n                   other=0.0)\n        \n        # Compute scores\n        scores = tl.dot(q, tl.trans(k))\n        scores *= scale\n        \n        # Causal masking\n        if IS_CAUSAL:\n            causal_mask = (start_m + offs_m[:, None]) >= (start_n + offs_n[None, :])\n            scores = tl.where(causal_mask, scores, float('-inf'))\n        \n        # Update statistics\n        m_i_new = tl.maximum(m_i, tl.max(scores, axis=1))\n        alpha = tl.exp(m_i - m_i_new)\n        p = tl.exp(scores - m_i_new[:, None])\n        \n        # Update accumulator\n        acc *= alpha[:, None]\n        acc += tl.dot(p, v)\n        \n        # Update normalization\n        l_i = l_i * alpha + tl.sum(p, axis=1)\n        m_i = m_i_new\n        \n    # Normalize and store output with head dimension mask\n    acc /= l_i[:, None]\n    out_ptr = Out + pid_batch * stride_ob + pid_head * stride_oh + \\\n              (offs_m[:, None] * stride_on + offs_d[None, :] * stride_od)\n    tl.store(out_ptr, acc, mask=(offs_m[:, None] < seq_len) & d_mask[None, :])\n\nclass CausalSelfAttention(nn.Module):\n    \"\"\"\n    A multi-head masked self-attention layer with FlashAttention.\n    \"\"\"\n\n    def __init__(self, n_embd, n_head, attn_pdrop, resid_pdrop, max_seqlen):\n        super().__init__()\n        assert n_embd % n_head == 0\n        # key, query, value projections for all heads, but in a batch\n        self.c_attn = nn.Linear(n_embd, 3 * n_embd)\n        # output projection\n        self.c_proj = nn.Linear(n_embd, n_embd)\n        # regularization\n        self.attn_dropout = nn.Dropout(attn_pdrop)\n        self.resid_dropout = nn.Dropout(resid_pdrop)\n        # causal mask to ensure that attention is only applied to the left in the input sequence\n        self.register_buffer(\"bias\", torch.tril(torch.ones(max_seqlen, max_seqlen))\n                                     .view(1, 1, max_seqlen, max_seqlen))\n        self.n_head = n_head\n        self.n_embd = n_embd\n        self.head_size = n_embd // n_head\n        # Compute next power of two for head dimension\n        self.BLOCK_D = 1 << (self.head_size - 1).bit_length()\n\n    def forward(self, x):\n        B, T, C = x.size()\n\n        # calculate query, key, values\n        q, k, v = self.c_attn(x).split(self.n_embd, dim=2)\n        k = k.view(B, T, self.n_head, self.head_size).transpose(1, 2)\n        q = q.view(B, T, self.n_head, self.head_size).transpose(1, 2)\n        v = v.view(B, T, self.n_head, self.head_size).transpose(1, 2)\n\n        # FlashAttention\n        y = torch.empty_like(q)\n        grid = (B, self.n_head, triton.cdiv(T, 64))\n        \n        _attn_fwd[grid](\n            q, k, v, y,\n            q.stride(0), q.stride(1), q.stride(2), q.stride(3),\n            k.stride(0), k.stride(1), k.stride(2), k.stride(3),\n            v.stride(0), v.stride(1), v.stride(2), v.stride(3),\n            y.stride(0), y.stride(1), y.stride(2), y.stride(3),\n            T, self.head_size,\n            BLOCK_M=64, BLOCK_N=64, BLOCK_DMODEL=self.BLOCK_D,\n            IS_CAUSAL=True\n        )\n        \n        # Re-assemble all head outputs\n        y = y.transpose(1, 2).contiguous().view(B, T, C)\n\n        # Output projection\n        y = self.resid_dropout(self.c_proj(y))\n        return y\n    \nclass ModelNew(nn.Module):\n    \"\"\" an unassuming Transformer block \"\"\"\n\n    def __init__(self, n_embd, n_head, attn_pdrop, resid_pdrop, max_seqlen):\n        super().__init__()\n        self.ln_1 = nn.LayerNorm(n_embd)\n        self.attn = CausalSelfAttention(n_embd, n_head, attn_pdrop, resid_pdrop, max_seqlen)\n        self.ln_2 = nn.LayerNorm(n_embd)\n        self.mlp = nn.ModuleDict(dict(\n            c_fc    = nn.Linear(n_embd, 4 * n_embd),\n            c_proj  = nn.Linear(4 * n_embd, n_embd),\n            act     = NewGELU(),\n            dropout = nn.Dropout(resid_pdrop),\n        ))\n        m = self.mlp\n        self.mlpf = lambda x: m.dropout(m.c_proj(m.act(m.c_fc(x)))) # MLP forward\n\n    def forward(self, x):\n        x = x + self.attn(self.ln_1(x))\n        x = x + self.mlpf(self.ln_2(x))\n        return x\n\nbatch_size = 128\nmax_seqlen = 1024\nseq_len = 512\nn_embd = 768\nn_head = 8\nattn_pdrop = 0.0\nresid_pdrop = 0.0\n\ndef get_inputs():\n    return [torch.randn(batch_size, seq_len, n_embd)]\n\ndef get_init_inputs():\n    return [n_embd, n_head, attn_pdrop, resid_pdrop, max_seqlen]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "703d04e9-8b83-4a21-92cf-aff03241816c", "generation": 2, "timestamp": 1754590619.2533562, "iteration_found": 10, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_44_MiniGPTBlock", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp_sair8iq.py\", line 182, in forward\n    x = x + self.attn(self.ln_1(x))\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp_sair8iq.py\", line 146, in forward\n    _attn_fwd[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 38:26:\n    k_ptr = K + pid_batch * stride_kb + pid_head * stride_kh + \\\n            (offs_n[:, None] * stride_kn + offs_d[None, :] * stride_kd)\n    v_ptr = V + pid_batch * stride_vb + pid_head * stride_vh + \\\n            (offs_n[:, None] * stride_vn + offs_d[None, :] * stride_vd)\n\n    # Initialize accumulator\n    acc = tl.zeros([BLOCK_M, BLOCK_DMODEL], dtype=tl.float32)\n    m_i = tl.zeros([BLOCK_M], dtype=tl.float32) - float('inf')\n    l_i = tl.zeros([BLOCK_M], dtype=tl.float32)\n\n    # Scale factor\n    scale = 1.0 / tl.sqrt(tl.float32(head_size))\n                          ^\nTypeError(\"'dtype' object is not callable\")\n\n\nThe above exception was the direct cause of the following exception:\n\nTypeError: 'dtype' object is not callable\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.489, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level3_44_MiniGPTBlock", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "runtime_error": "Traceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1654, in arange\n    return _semantic.arange(start, end)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 583, in arange\n    raise ValueError(\"arange's range must be a power of 2\")\nValueError: arange's range must be a power of 2\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp4jfzfagc.py\", line 171, in forward\n    x = x + self.attn(self.ln_1(x))\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmp4jfzfagc.py\", line 135, in forward\n    _attn_fwd[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 594, in run\n    kernel = self.compile(src, target=target, options=options.__dict__)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 339, in compile\n    module = src.make_ir(options, codegen_fns, module_map, context)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/compiler/compiler.py\", line 83, in make_ir\n    return ast_to_ttir(self.fn, self, context=context, options=options, codegen_fns=codegen_fns,\ntriton.compiler.errors.CompilationError: at 19:13:\n    head_size,\n    BLOCK_M: tl.constexpr, BLOCK_N: tl.constexpr, BLOCK_DMODEL: tl.constexpr,\n    IS_CAUSAL: tl.constexpr\n):\n    pid_batch = tl.program_id(0)\n    pid_head = tl.program_id(1)\n    pid_m = tl.program_id(2)\n\n    start_m = pid_m * BLOCK_M\n    offs_m = start_m + tl.arange(0, BLOCK_M)\n    offs_n = tl.arange(0, BLOCK_N)\n    offs_d = tl.arange(0, BLOCK_DMODEL)\n             ^\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 42, in wrapper\n    return fn(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/core.py\", line 1654, in arange\n    return _semantic.arange(start, end)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/language/semantic.py\", line 583, in arange\n    raise ValueError(\"arange's range must be a power of 2\")\nValueError: arange's range must be a power of 2\n", "runtime_error_name": "triton.compiler.errors.CompilationError", "reference_timing_ms": 0.489, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}