{"id": "41d3eaab-2744-43cc-a050-d2264ea3ad54", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef fused_ops_kernel(\n    x_ptr,\n    subtract_ptr,\n    output_ptr,\n    channels,\n    batch_size,\n    D, H, W,\n    x_stride_batch, x_stride_channel, x_stride_d, x_stride_h, x_stride_w,\n    out_stride_batch, out_stride_d, out_stride_h, out_stride_w,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    total_positions = batch_size * D * H * W\n    if pid >= total_positions:\n        return\n    \n    # Compute spatial indices\n    w = pid % W\n    h = (pid // W) % H\n    d = (pid // (W * H)) % D\n    batch_id = pid // (W * H * D)\n    \n    # Base pointer for input\n    base = batch_id * x_stride_batch + d * x_stride_d + h * x_stride_h + w * x_stride_w\n    \n    # Load channel vector\n    channel_offsets = tl.arange(0, BLOCK_SIZE)\n    mask = channel_offsets < channels\n    vec = tl.load(x_ptr + base + channel_offsets * x_stride_channel, mask=mask, other=float('-inf'))\n    \n    # Compute softmax\n    max_val = tl.max(vec, axis=0)\n    vec = vec - max_val\n    exp_vec = tl.exp(vec)\n    sum_exp = tl.sum(exp_vec, axis=0)\n    softmax_vec = exp_vec / sum_exp\n    \n    # Load subtract vector and apply\n    sub_vec = tl.load(subtract_ptr + channel_offsets, mask=mask, other=0.0)\n    softmax_vec = softmax_vec - sub_vec\n    \n    # Swish activation\n    swish_vec = softmax_vec * tl.sigmoid(softmax_vec)\n    \n    # Max reduction\n    result = tl.max(swish_vec, axis=0)\n    \n    # Store result\n    out_base = batch_id * out_stride_batch + d * out_stride_d + h * out_stride_h + w * out_stride_w\n    tl.store(output_ptr + out_base, result)\n\nclass ModelNew(nn.Module):\n    def __init__(self, in_channels, out_channels, kernel_size, stride, padding, output_padding, pool_kernel_size, pool_stride, pool_padding):\n        super(ModelNew, self).__init__()\n        self.conv_transpose = nn.ConvTranspose3d(in_channels, out_channels, kernel_size, stride=stride, padding=padding, output_padding=output_padding)\n        self.max_pool = nn.MaxPool3d(kernel_size=pool_kernel_size, stride=pool_stride, padding=pool_padding)\n        self.subtract = nn.Parameter(torch.randn(out_channels))\n\n    def forward(self, x):\n        x = self.conv_transpose(x)\n        x = self.max_pool(x)\n        \n        # Extract tensor dimensions\n        batch, channels, D, H, W = x.shape\n        total_positions = batch * D * H * W\n        \n        # Prepare output tensor\n        output = torch.empty(batch, D, H, W, device=x.device, dtype=x.dtype)\n        \n        # Get strides\n        x_strides = x.stride()\n        out_strides = output.stride()\n        \n        # Launch kernel\n        BLOCK_SIZE = triton.next_power_of_2(channels)\n        grid = (total_positions,)\n        fused_ops_kernel[grid](\n            x, self.subtract, output, channels, batch, D, H, W,\n            x_strides[0], x_strides[1], x_strides[2], x_strides[3], x_strides[4],\n            out_strides[0], out_strides[1], out_strides[2], out_strides[3],\n            BLOCK_SIZE\n        )\n        \n        return output\n\nbatch_size = 128\nin_channels = 3\nout_channels = 16\ndepth, height, width = 16, 32, 32\nkernel_size = 3\nstride = 2\npadding = 1\noutput_padding = 1\npool_kernel_size = 2\npool_stride = 2\npool_padding = 0\n\ndef get_inputs():\n    return [torch.randn(batch_size, in_channels, depth, height, width)]\n\ndef get_init_inputs():\n    return [in_channels, out_channels, kernel_size, stride, padding, output_padding, pool_kernel_size, pool_stride, pool_padding]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "03df8878-9a80-4870-8f6b-5a29f766c191", "generation": 1, "timestamp": 1754580701.7893367, "iteration_found": 4, "metrics": {"compiled": true, "correctness": true, "stage": "success", "passed": false, "score": 20, "speed_up": 0.019, "runtime_ms": 6.96, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:4", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.129, "speed_up": 0.019, "custom_timing": 6.96}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": true, "stage": "reference code", "passed": false, "score": 0.0, "speed_up": 1.0, "runtime_ms": 5.68, "meta": {"hardware": "NVIDIA L20Y", "device": "cuda:4", "correctness_trials": "(5 / 5)", "reference_timing_ms": 0.129, "speed_up": 0.023, "custom_timing": 5.68}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}