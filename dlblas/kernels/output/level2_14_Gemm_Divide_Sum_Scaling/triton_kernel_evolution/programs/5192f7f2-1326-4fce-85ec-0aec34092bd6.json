{"id": "5192f7f2-1326-4fce-85ec-0aec34092bd6", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.jit\ndef _forward_kernel(\n    x_ptr,\n    weight_ptr,\n    output_ptr,\n    scaling_factor,\n    INPUT_SIZE: tl.constexpr,\n    BLOCK_SIZE: tl.constexpr,\n    N_BLOCKS: tl.constexpr,\n    batch_size,\n    stride_x,\n    stride_w,\n    **meta\n):\n    pid = tl.program_id(0)\n    if pid >= batch_size:\n        return\n\n    accumulator = tl.zeros((1,), dtype=tl.float32)\n    for i in range(0, N_BLOCKS):\n        offset = i * BLOCK_SIZE\n        cols = offset + tl.arange(0, BLOCK_SIZE)\n        mask = cols < INPUT_SIZE\n\n        x_block = tl.load(x_ptr + pid * stride_x + cols, mask=mask, other=0.0)\n        w_block = tl.load(weight_ptr + cols * stride_w, mask=mask, other=0.0)\n\n        accumulator += tl.sum(x_block * w_block, axis=0)\n\n    result = accumulator * (scaling_factor / 2.0)\n    tl.store(output_ptr + pid, result)\n\nclass ModelNew(nn.Module):\n    \"\"\"\n    Optimized model using Triton for fused operations.\n    \"\"\"\n    def __init__(self, input_size, hidden_size, scaling_factor):\n        super(ModelNew, self).__init__()\n        self.weight = nn.Parameter(torch.randn(hidden_size, input_size))\n        self.scaling_factor = scaling_factor\n        self.input_size = input_size\n        # Precompute block size and number of blocks\n        self.block_size = min(triton.next_power_of_2(input_size), 1024) if input_size > 0 else 1\n        self.num_blocks = (input_size + self.block_size - 1) // self.block_size if input_size > 0 else 0\n\n    def forward(self, x):\n        weight_vector = self.weight.sum(dim=0).contiguous()  # [input_size]\n        batch_size = x.shape[0]\n        output = torch.empty(batch_size, device=x.device, dtype=x.dtype)\n\n        if batch_size == 0 or self.input_size == 0:\n            return output.unsqueeze(1)\n\n        grid = (batch_size,)\n        scaling_factor_val = self.scaling_factor\n        if isinstance(scaling_factor_val, torch.Tensor):\n            scaling_factor_val = scaling_factor_val.item()\n\n        _forward_kernel[grid](\n            x, \n            weight_vector, \n            output,\n            scaling_factor_val,\n            self.input_size,\n            self.block_size,\n            self.num_blocks,\n            batch_size,\n            stride_x=x.stride(0),\n            stride_w=1,\n            num_warps=8\n        )\n        return output.unsqueeze(1)\n\nbatch_size = 128\ninput_size = 10\nhidden_size = 20\nscaling_factor = 1.5\n\ndef get_inputs():\n    return [torch.randn(batch_size, input_size)]\n\ndef get_init_inputs():\n    return [input_size, hidden_size, scaling_factor]\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "9f85595f-e93f-47fb-87a7-55fd4e1a5722", "generation": 3, "timestamp": 1754569040.2135408, "iteration_found": 20, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_14_Gemm_Divide_Sum_Scaling", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:2", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpydqlh_2l.py\", line 65, in forward\n    _forward_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 561, in run\n    bound_args, specialization, options = binder(*args, **kwargs)\nTypeError: dynamic_func() missing 1 required positional argument: 'meta'\n", "runtime_error_name": "builtins.TypeError", "reference_timing_ms": 0.0556, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level2_14_Gemm_Divide_Sum_Scaling", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:7", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpa15o8elu.py\", line 63, in forward\n    self._forward_kernel[grid](\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 390, in <lambda>\n    return lambda *args, **kwargs: self.run(grid=grid, warmup=False, *args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/triton/runtime/jit.py\", line 561, in run\n    bound_args, specialization, options = binder(*args, **kwargs)\nTypeError: dynamic_func() missing 1 required positional argument: 'meta'\n", "runtime_error_name": "builtins.TypeError", "reference_timing_ms": 0.0556, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "island": 0}, "artifacts_json": null, "artifact_dir": null}