{"id": "36fae53c-9486-4b19-bf1b-0d6f63ee7d8e", "code": "# ================== EVOLVE-BLOCK-START ==================\nimport torch\nimport torch.nn as nn\nimport triton\nimport triton.language as tl\n\n@triton.autotune(\n    configs=[\n        triton.Config({\"BLOCK_SIZE\": 128}, num_warps=1),\n        triton.Config({\"BLOCK_SIZE\": 256}, num_warps=2),\n        triton.Config({\"BLOCK_SIZE\": 512}, num_warps=4),\n        triton.Config({\"BLOCK_SIZE\": 1024}, num_warps=8),\n        triton.Config({\"BLOCK_SIZE\": 2048}, num_warps=8),\n    ],\n    key=[\"n_elements\"],\n)\n@triton.jit\ndef _hinge_loss_kernel(\n    pred_ptr, \n    target_ptr, \n    output_ptr, \n    n_elements,\n    BLOCK_SIZE: tl.constexpr,\n):\n    pid = tl.program_id(0)\n    offsets = pid * BLOCK_SIZE + tl.arange(0, BLOCK_SIZE)\n    mask = offsets < n_elements\n    \n    # Vectorized loads for memory efficiency\n    pred = tl.load(pred_ptr + offsets, mask=mask, other=0.0)\n    target = tl.load(target_ptr + offsets, mask=mask, other=0.0)\n    \n    # Compute hinge loss: max(0, 1 - pred*target)\n    product = pred * target\n    hinge = 1.0 - product\n    clamped = tl.where(hinge > 0, hinge, 0.0)\n    \n    # Efficient block-wise reduction\n    partial_sum = tl.sum(clamped, axis=0)\n    tl.store(output_ptr + pid, partial_sum)\n\nclass ModelNew(nn.Module):\n    def __init__(self):\n        super().__init__()\n    \n    def forward(self, predictions, targets):\n        predictions_flat = predictions.contiguous().view(-1)\n        targets_flat = targets.contiguous().view(-1)\n        n_elements = predictions_flat.numel()\n        \n        if n_elements == 0:\n            return torch.tensor(0.0, device=predictions.device)\n        \n        # Use Triton for CUDA tensors\n        if predictions_flat.is_cuda:\n            # Get optimal config from autotune\n            grid = lambda meta: (triton.cdiv(n_elements, meta[\"BLOCK_SIZE\"]),)\n            partial_sums = torch.zeros(grid({\"n_elements\": n_elements}), \n                                      device=predictions.device, dtype=torch.float32)\n            \n            # Launch kernel\n            _hinge_loss_kernel[grid](\n                predictions_flat, \n                targets_flat, \n                partial_sums, \n                n_elements,\n                BLOCK_SIZE=None,  # Set by autotune\n            )\n            \n            # Final reduction on GPU\n            total_loss = torch.sum(partial_sums) / n_elements\n            return total_loss\n        else:\n            # Fallback to PyTorch for CPU\n            return torch.mean(torch.clamp(1 - predictions * targets, min=0))\n\nbatch_size = 128\ninput_shape = (1,)\ndim = 1\n\ndef get_inputs():\n    return [torch.randn(batch_size, *input_shape), torch.randint(0, 2, (batch_size, 1)).float() * 2 - 1]\n\ndef get_init_inputs():\n    return []\n# =================== EVOLVE-BLOCK-END ===================", "language": "python", "parent_id": "489259ac-b518-43d9-862b-c0760ff6c711", "generation": 3, "timestamp": 1754638351.8110142, "iteration_found": 26, "metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level1_100_HingeLoss", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "runtime_error": "Traceback (most recent call last):\n  File \"/cpfs01/shared/llm_kernel/hujiakai/KernelLLM/validation_api_server/helpers/evaluations.py\", line 720, in run_and_check_correctness\n    output_new = model_new(*inputs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1773, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n  File \"/home/lijiaxing/.conda/envs/api/lib/python3.10/site-packages/torch/nn/modules/module.py\", line 1784, in _call_impl\n    return forward_call(*args, **kwargs)\n  File \"/tmp/tmpda7nax31.py\", line 58, in forward\n    partial_sums = torch.zeros(grid({\"n_elements\": n_elements}),\n  File \"/tmp/tmpda7nax31.py\", line 57, in <lambda>\n    grid = lambda meta: (triton.cdiv(n_elements, meta[\"BLOCK_SIZE\"]),)\nKeyError: 'BLOCK_SIZE'\n", "runtime_error_name": "builtins.KeyError", "reference_timing_ms": 0.0478, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "complexity": 0.0, "diversity": 0.0, "metadata": {"changes": "Full rewrite", "parent_metrics": {"compiled": true, "correctness": false, "score": 10, "stage": "wrong_answer", "verify_payload": {"id": "level1_100_HingeLoss", "result": {"compiled": true, "correctness": false, "metadata": {"hardware": "NVIDIA L20Y", "device": "cuda:5", "max_difference": ["7.000000", "7.000000", "7.000000", "7.000000", "7.000000"], "avg_difference": ["7.000000", "7.000000", "7.000000", "7.000000", "7.000000"], "correctness_issue": "Output mismatch", "correctness_trials": "(0 / 5)", "reference_timing_ms": 0.0478, "speed_up": -1.0, "custom_timing": -1.0}, "runtime": -1.0, "runtime_stats": {}}}}, "island": 2}, "artifacts_json": null, "artifact_dir": null}